<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/assets/config/favicon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/assets/config/favicon.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/assets/config/favicon.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"kyleezhang.com","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"enable":true,"style":"tabs","active":false,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="Vue CLI vue-cli 在 3.0 版本进行了彻底的重构，为了区别也将其普遍称为 Vue CLI，是目前 Vue 官方推荐的 Vue 项目快速开发的完整系统，它基于 Webpack 实现，提供了终端命令行工具、零配置脚手架、插件体系、图形化管理界面等诸多功能，近乎提供了前端项目工程化的所有步骤的完整工具链，也是当前 Vue 项目构建的主流工具。  一、整体架构 vue-cli 为了尽可能">
<meta property="og:type" content="article">
<meta property="og:title" content="从vue-cli到Vue CLI（二）">
<meta property="og:url" content="http://kyleezhang.com/2021/05/15/vue-cli-02/index.html">
<meta property="og:site_name" content="kyleezhang&#96;s Blog">
<meta property="og:description" content="Vue CLI vue-cli 在 3.0 版本进行了彻底的重构，为了区别也将其普遍称为 Vue CLI，是目前 Vue 官方推荐的 Vue 项目快速开发的完整系统，它基于 Webpack 实现，提供了终端命令行工具、零配置脚手架、插件体系、图形化管理界面等诸多功能，近乎提供了前端项目工程化的所有步骤的完整工具链，也是当前 Vue 项目构建的主流工具。  一、整体架构 vue-cli 为了尽可能">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://kyleezhang.com/assets/vue-cli/05.png">
<meta property="og:image" content="http://kyleezhang.com/assets/emoji/03.png">
<meta property="og:image" content="http://kyleezhang.com/assets/vue-cli/06.png">
<meta property="og:image" content="http://kyleezhang.com/assets/vue-cli/07.png">
<meta property="og:image" content="http://kyleezhang.com/assets/vue-cli/08.png">
<meta property="og:image" content="http://kyleezhang.com/assets/emoji/04.png">
<meta property="og:image" content="http://kyleezhang.com/assets/emoji/05.jpg">
<meta property="article:published_time" content="2021-05-15T12:00:35.000Z">
<meta property="article:modified_time" content="2022-05-05T01:40:34.646Z">
<meta property="article:author" content="kyleezhang">
<meta property="article:tag" content="cli">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://kyleezhang.com/assets/vue-cli/05.png">

<link rel="canonical" href="http://kyleezhang.com/2021/05/15/vue-cli-02/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>从vue-cli到Vue CLI（二） | kyleezhang`s Blog</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-2KR3NK700N"></script>
    <script>
      if (CONFIG.hostname === location.hostname) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-2KR3NK700N');
      }
    </script>


  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?f1621cb3fb0792bb294fce1b938d5eef";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="kyleezhang`s Blog" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband">
    <a target="_blank" rel="noopener" href="https://github.com/kyleezhang " class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#fff; color:#151513; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>
    </div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">kyleezhang`s Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-sitemap">

    <a href="/sitemap.xml" rel="section"><i class="fa fa-sitemap fa-fw"></i>站点地图</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://kyleezhang.com/2021/05/15/vue-cli-02/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/assets/config/avatar.png">
      <meta itemprop="name" content="kyleezhang">
      <meta itemprop="description" content="学源于思">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="kyleezhang`s Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          从vue-cli到Vue CLI（二）
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-05-15 12:00:35" itemprop="dateCreated datePublished" datetime="2021-05-15T12:00:35+00:00">2021-05-15</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-05-05 01:40:34" itemprop="dateModified" datetime="2022-05-05T01:40:34+00:00">2022-05-05</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%89%8D%E7%AB%AF%E5%B7%A5%E7%A8%8B%E5%8C%96/" itemprop="url" rel="index"><span itemprop="name">前端工程化</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span id="busuanzi_value_page_pv"></span>
            </span><br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>70k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1:04</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h2 id="vue-cli"><a class="markdownIt-Anchor" href="#vue-cli"></a> Vue CLI</h2>
<p>vue-cli 在 3.0 版本进行了彻底的重构，为了区别也将其普遍称为 Vue CLI，是目前 Vue 官方推荐的 Vue 项目快速开发的完整系统，它基于 Webpack 实现，提供了终端命令行工具、零配置脚手架、插件体系、图形化管理界面等诸多功能，近乎提供了前端项目工程化的所有步骤的完整工具链，也是当前 Vue 项目构建的主流工具。</p>
<h3 id="一-整体架构"><a class="markdownIt-Anchor" href="#一-整体架构"></a> 一、整体架构</h3>
<p>vue-cli 为了尽可能覆盖项目工程化需求所以模版项目往往引入了大量第三方库，但实际开发过程中开发者可能并不需要这些功能模块，虽然可以通过在模版项目的 meta.js 或 meta.json 文件配置 prompts 在命令行交互然后在 filterFiles 函数中对生成项目的文件目录结构进行筛选，但是依然可配置性不强，会存在较多冗余依赖或功能，并且依赖项的升级极为痛苦，因此为了给开发者提供更灵活的配置能力 Vue CLI 实现了一种极为巧妙的架构设计：</p>
<a id="more"></a>
<img src="/assets/vue-cli/05.png" width="400" />
<p>如上图所示，Vue CLI 的最新架构主要由如下模块构成：</p>
<p>1、@vue/cli: 首先我们会在全局安装一个@vue/cli，其为我们提供了一系列 vue 命令，例如我们最常用 vue create、vue add 指令等等。@vue/cli 本质上依然是脚手架工具，主要通过 CLI 交互自动化创建项目基础结构，具体步骤为：</p>
<ul>
<li>准备命令行交互的问题</li>
<li>根据用户的回答决定是否使用某个插件（内置）</li>
<li>调用 npm/yarn 自动在项目本地安装这些插件</li>
<li>调用每个插件内部的 generator 方法</li>
<li>generator 内部创建所有文件</li>
</ul>
<p>2、@vue/cli-service: 如果说 @vue/cli 的主要作用是项目的生成，那么 @vue/cli-service 才是开发者日常开发的真正核心，为我们提供了 Vue.js 开发环境的 CLI 服务（本地测试、生产环境构建等等），因此它提供的主要功能点如下所示：</p>
<ul>
<li>提供了一个适用于大多数 Vue.js 项目的 Webpack 配置，并且内部只做最通用的配置。</li>
<li>把 Webpack 与 Webpack Dev Server 封装进内部，提供 server &amp; build 命令。</li>
<li>加载其他 CLI 插件内部的核心服务。</li>
</ul>
<p>3、@vue/cli-plugin-xxx: 个人觉得 Vue CLI 设计最出彩的地方就在于插件机制，项目本身创建最开始的时候只是根据用户在命令行的交互问题生成 package.json，然后根据所拥有的模块动态完成 Webpack 的配置并生成项目结构，因此 Vue CLI 的插件模块主要完成如下功能：</p>
<ul>
<li>提供了个性化的 Webpack 配置，让构建过程支持不同的技术选型</li>
<li>提供了 Generator 用于生成项目中所需的文件</li>
<li>提供了额外的 Command 用于实现扩展功能，例如 cli-plugin-eslint 插件中提供了 lint 子命令</li>
</ul>
<p>下面我们开始详细分析每一个模块来查看其功能的具体实现：</p>
<img src="/assets/emoji/03.png" width="260" />
<h3 id="二-vuecli"><a class="markdownIt-Anchor" href="#二-vuecli"></a> 二、@vue/cli</h3>
<p>@vue/cli 主要为我们提供了一系列 vue 命令，具体如下图所示：</p>
<img src="/assets/vue-cli/06.png" width="800" />
<p>这些指令都是在 <code>@vue/cli/bin/vue.js</code> 文件中通过 command 库的 command 方法指定的，此处比较有意思的是 @vue/cli 提供了 suggestCommands 函数，用于对用户在命令行的错误输入分析并给出猜测指令，具体实现如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// @vue/cli/bin/vue.js</span></span><br><span class="line">...</span><br><span class="line"><span class="comment">// output help information on unknown commands</span></span><br><span class="line"><span class="comment">// 如果不是前文已挂载的命令开始执行如下函数</span></span><br><span class="line">program.on(<span class="string">&#x27;command:*&#x27;</span>, <span class="function">(<span class="params">[cmd]</span>) =&gt;</span> &#123;</span><br><span class="line">  program.outputHelp()</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`  `</span> + chalk.red(<span class="string">`Unknown command <span class="subst">$&#123;chalk.yellow(cmd)&#125;</span>.`</span>))</span><br><span class="line">  <span class="built_in">console</span>.log()</span><br><span class="line">  suggestCommands(cmd)</span><br><span class="line">  process.exitCode = <span class="number">1</span></span><br><span class="line">&#125;)</span><br><span class="line">...</span><br><span class="line"><span class="comment">// 猜测用户意图</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">suggestCommands</span> (<span class="params">unknownCommand</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> availableCommands = program.commands.map(<span class="function"><span class="params">cmd</span> =&gt;</span> cmd._name)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> suggestion</span><br><span class="line"></span><br><span class="line">  availableCommands.forEach(<span class="function"><span class="params">cmd</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> isBestMatch = leven(cmd, unknownCommand) &lt; leven(suggestion || <span class="string">&#x27;&#x27;</span>, unknownCommand)</span><br><span class="line">    <span class="keyword">if</span> (leven(cmd, unknownCommand) &lt; <span class="number">3</span> &amp;&amp; isBestMatch) &#123;</span><br><span class="line">      suggestion = cmd</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (suggestion) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`  `</span> + chalk.red(<span class="string">`Did you mean <span class="subst">$&#123;chalk.yellow(suggestion)&#125;</span>?`</span>))</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>代码中使用了 leven 了这个包，这是用于计算字符串编辑距离算法的 JS 实现，Vue CLI 这里使用了这个包，来分别计算输入的命令和当前已挂载的所有命令的编辑举例，从而猜测用户实际想输入的命令是哪个。一个简单功能的实现，但极大程度地提升了用户体验👍。</p>
<p>首先我们开始分析项目创建最核心的 create 命令：</p>
<h4 id="1-create-命令"><a class="markdownIt-Anchor" href="#1-create-命令"></a> 1、create 命令</h4>
<p>我们首先查看 create 命令的入口：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// packages/@vue/cli/bin/vue.js</span></span><br><span class="line">program</span><br><span class="line">  .command(<span class="string">&#x27;create &lt;app-name&gt;&#x27;</span>)</span><br><span class="line">  .description(<span class="string">&#x27;create a new project powered by vue-cli-service&#x27;</span>)</span><br><span class="line">  .option(<span class="string">&#x27;-p, --preset &lt;presetName&gt;&#x27;</span>, <span class="string">&#x27;Skip prompts and use saved or remote preset&#x27;</span>)</span><br><span class="line">  .option(<span class="string">&#x27;-d, --default&#x27;</span>, <span class="string">&#x27;Skip prompts and use default preset&#x27;</span>)</span><br><span class="line">  .option(<span class="string">&#x27;-i, --inlinePreset &lt;json&gt;&#x27;</span>, <span class="string">&#x27;Skip prompts and use inline JSON string as preset&#x27;</span>)</span><br><span class="line">  .option(<span class="string">&#x27;-m, --packageManager &lt;command&gt;&#x27;</span>, <span class="string">&#x27;Use specified npm client when installing dependencies&#x27;</span>)</span><br><span class="line">  .option(<span class="string">&#x27;-r, --registry &lt;url&gt;&#x27;</span>, <span class="string">&#x27;Use specified npm registry when installing dependencies (only for npm)&#x27;</span>)</span><br><span class="line">  .option(<span class="string">&#x27;-g, --git [message]&#x27;</span>, <span class="string">&#x27;Force git initialization with initial commit message&#x27;</span>)</span><br><span class="line">  .option(<span class="string">&#x27;-n, --no-git&#x27;</span>, <span class="string">&#x27;Skip git initialization&#x27;</span>)</span><br><span class="line">  .option(<span class="string">&#x27;-f, --force&#x27;</span>, <span class="string">&#x27;Overwrite target directory if it exists&#x27;</span>)</span><br><span class="line">  .option(<span class="string">&#x27;-c, --clone&#x27;</span>, <span class="string">&#x27;Use git clone when fetching remote preset&#x27;</span>)</span><br><span class="line">  .option(<span class="string">&#x27;-x, --proxy&#x27;</span>, <span class="string">&#x27;Use specified proxy when creating project&#x27;</span>)</span><br><span class="line">  .option(<span class="string">&#x27;-b, --bare&#x27;</span>, <span class="string">&#x27;Scaffold project without beginner instructions&#x27;</span>)</span><br><span class="line">  .action(<span class="function">(<span class="params">name, options</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (minimist(process.argv.slice(<span class="number">3</span>))._.length &gt; <span class="number">1</span>) &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(chalk.yellow(<span class="string">&#x27;\n Info: You provided more than one argument. The first one will be used as the app\&#x27;s name, the rest are ignored.&#x27;</span>))</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// --git makes commander to default git to true</span></span><br><span class="line">    <span class="keyword">if</span> (process.argv.includes(<span class="string">&#x27;-g&#x27;</span>) || process.argv.includes(<span class="string">&#x27;--git&#x27;</span>)) &#123;</span><br><span class="line">      options.forceGit = <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">require</span>(<span class="string">&#x27;../lib/create&#x27;</span>)(name, options)</span><br><span class="line">  &#125;)</span><br></pre></td></tr></table></figure>
<p>上述参数的具体作用如下所示：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">-p, --preset &lt;presetName&gt;       忽略提示符并使用已保存的或远程的预设选项</span><br><span class="line">-d, --default                   忽略提示符并使用默认预设选项</span><br><span class="line">-i, --inlinePreset &lt;json&gt;       忽略提示符并使用内联的 JSON 字符串预设选项</span><br><span class="line">-m, --packageManager &lt;<span class="built_in">command</span>&gt;  在安装依赖时使用指定的 npm 客户端</span><br><span class="line">-r, --registry &lt;url&gt;            在安装依赖时使用指定的 npm registry</span><br><span class="line">-g, --git [message]             强制 / 跳过 git 初始化，并可选的指定初始化提交信息</span><br><span class="line">-n, --no-git                    跳过 git 初始化</span><br><span class="line">-f, --force                     覆写目标目录可能存在的配置</span><br><span class="line">-c, --<span class="built_in">clone</span>                     使用 git <span class="built_in">clone</span> 获取远程预设选项</span><br><span class="line">-x, --proxy                     使用指定的代理创建项目</span><br><span class="line">-b, --bare                      创建项目时省略默认组件中的新手指导信息</span><br><span class="line">-h, --<span class="built_in">help</span>                      输出使用帮助信息</span><br></pre></td></tr></table></figure>
<p>具体的执行则主要是调用了 <code>../lib/create.js</code> 文件暴露出的 create 方法：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">create</span> (<span class="params">projectName, options</span>) </span>&#123;</span><br><span class="line">   <span class="keyword">if</span> (options.proxy) &#123;</span><br><span class="line">    process.env.HTTP_PROXY = options.proxy <span class="comment">// 根据用户是否配置 proxy 项创建环境变量 HTTP_PROXY</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> cwd = options.cwd || process.cwd() <span class="comment">// 当前目录</span></span><br><span class="line">  <span class="keyword">const</span> inCurrent = projectName === <span class="string">&#x27;.&#x27;</span> <span class="comment">// 是否在当前目录</span></span><br><span class="line">  <span class="keyword">const</span> name = inCurrent ? path.relative(<span class="string">&#x27;../&#x27;</span>, cwd) : projectName <span class="comment">// 项目名称</span></span><br><span class="line">  <span class="keyword">const</span> targetDir = path.resolve(cwd, projectName || <span class="string">&#x27;.&#x27;</span>) <span class="comment">// 生成项目的目录</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> result = validateProjectName(name) <span class="comment">// 调用 validate-npm-package-name 库校验项目名称</span></span><br><span class="line">  <span class="keyword">if</span> (!result.validForNewPackages) &#123;</span><br><span class="line">    <span class="built_in">console</span>.error(chalk.red(<span class="string">`Invalid project name: &quot;<span class="subst">$&#123;name&#125;</span>&quot;`</span>))</span><br><span class="line">    result.errors &amp;&amp; result.errors.forEach(<span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.error(chalk.red.dim(<span class="string">&#x27;Error: &#x27;</span> + err))</span><br><span class="line">    &#125;)</span><br><span class="line">    result.warnings &amp;&amp; result.warnings.forEach(<span class="function"><span class="params">warn</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.error(chalk.red.dim(<span class="string">&#x27;Warning: &#x27;</span> + warn))</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 此处代码主要用于项目生成路径的判断，主要是当存在相同项目目录的时候调用 inquirer.prompt 来询问是否要 Overwrite || Merge || Cancel，当带有 -f || --force 的时候会跳过这些交互，即 options force = true</span></span><br><span class="line">  <span class="keyword">if</span> (fs.existsSync(targetDir) &amp;&amp; !options.merge) &#123;</span><br><span class="line">    <span class="keyword">if</span> (options.force) &#123;</span><br><span class="line">      <span class="keyword">await</span> fs.remove(targetDir)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">await</span> clearConsole()</span><br><span class="line">      <span class="keyword">if</span> (inCurrent) &#123;</span><br><span class="line">        <span class="keyword">const</span> &#123; ok &#125; = <span class="keyword">await</span> inquirer.prompt([</span><br><span class="line">          &#123;</span><br><span class="line">            name: <span class="string">&#x27;ok&#x27;</span>,</span><br><span class="line">            type: <span class="string">&#x27;confirm&#x27;</span>,</span><br><span class="line">            message: <span class="string">`Generate project in current directory?`</span></span><br><span class="line">          &#125;</span><br><span class="line">        ])</span><br><span class="line">        <span class="keyword">if</span> (!ok) &#123;</span><br><span class="line">          <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> &#123; action &#125; = <span class="keyword">await</span> inquirer.prompt([</span><br><span class="line">          &#123;</span><br><span class="line">            name: <span class="string">&#x27;action&#x27;</span>,</span><br><span class="line">            type: <span class="string">&#x27;list&#x27;</span>,</span><br><span class="line">            message: <span class="string">`Target directory <span class="subst">$&#123;chalk.cyan(targetDir)&#125;</span> already exists. Pick an action:`</span>,</span><br><span class="line">            choices: [</span><br><span class="line">              &#123; <span class="attr">name</span>: <span class="string">&#x27;Overwrite&#x27;</span>, <span class="attr">value</span>: <span class="string">&#x27;overwrite&#x27;</span> &#125;,</span><br><span class="line">              &#123; <span class="attr">name</span>: <span class="string">&#x27;Merge&#x27;</span>, <span class="attr">value</span>: <span class="string">&#x27;merge&#x27;</span> &#125;,</span><br><span class="line">              &#123; <span class="attr">name</span>: <span class="string">&#x27;Cancel&#x27;</span>, <span class="attr">value</span>: <span class="literal">false</span> &#125;</span><br><span class="line">            ]</span><br><span class="line">          &#125;</span><br><span class="line">        ])</span><br><span class="line">        <span class="keyword">if</span> (!action) &#123;</span><br><span class="line">          <span class="keyword">return</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (action === <span class="string">&#x27;overwrite&#x27;</span>) &#123;</span><br><span class="line">          <span class="built_in">console</span>.log(<span class="string">`\nRemoving <span class="subst">$&#123;chalk.cyan(targetDir)&#125;</span>...`</span>)</span><br><span class="line">          <span class="keyword">await</span> fs.remove(targetDir)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> creator = <span class="keyword">new</span> Creator(name, targetDir, getPromptModules())</span><br><span class="line">  <span class="keyword">await</span> creator.create(options)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function">(<span class="params">...args</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> create(...args).catch(<span class="function"><span class="params">err</span> =&gt;</span> &#123; <span class="comment">// 捕获内部所有抛出的错误，将当前的 spinner  状态停止，退出进程。</span></span><br><span class="line">    stopSpinner(<span class="literal">false</span>) <span class="comment">// do not persist</span></span><br><span class="line">    error(err)</span><br><span class="line">    <span class="keyword">if</span> (!process.env.VUE_CLI_TEST) &#123;</span><br><span class="line">      process.exit(<span class="number">1</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>此处经过认真的代码分析我们成功发现真正实现的核心都在 <code>../lib/Creator</code> 的 Creator 类中😓，，，但是这儿 getPromptModules 方法的作用是什么呢？</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">exports</span>.getPromptModules = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> [</span><br><span class="line">    <span class="string">&#x27;vueVersion&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;babel&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;typescript&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;pwa&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;router&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;vuex&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;cssPreprocessors&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;linter&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;unit&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;e2e&#x27;</span></span><br><span class="line">  ].map(<span class="function"><span class="params">file</span> =&gt;</span> <span class="built_in">require</span>(<span class="string">`../promptModules/<span class="subst">$&#123;file&#125;</span>`</span>))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>getPromptModules 函数主要用于 <code>../promptModules/</code> 文件夹下不同配置文件内容的读取，我们以 <code>../promptModules/unit.js</code> 为例：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//../promptModules/unit.js</span></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="params">cli</span> =&gt;</span> &#123;</span><br><span class="line">  cli.injectFeature(&#123;</span><br><span class="line">    name: <span class="string">&#x27;Unit Testing&#x27;</span>,</span><br><span class="line">    value: <span class="string">&#x27;unit&#x27;</span>,</span><br><span class="line">    short: <span class="string">&#x27;Unit&#x27;</span>,</span><br><span class="line">    description: <span class="string">&#x27;Add a Unit Testing solution like Jest or Mocha&#x27;</span>,</span><br><span class="line">    link: <span class="string">&#x27;https://cli.vuejs.org/config/#unit-testing&#x27;</span>,</span><br><span class="line">    plugins: [<span class="string">&#x27;unit-jest&#x27;</span>, <span class="string">&#x27;unit-mocha&#x27;</span>]</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  cli.injectPrompt(&#123;</span><br><span class="line">    name: <span class="string">&#x27;unit&#x27;</span>,</span><br><span class="line">    when: <span class="function"><span class="params">answers</span> =&gt;</span> answers.features.includes(<span class="string">&#x27;unit&#x27;</span>),</span><br><span class="line">    type: <span class="string">&#x27;list&#x27;</span>,</span><br><span class="line">    message: <span class="string">&#x27;Pick a unit testing solution:&#x27;</span>,</span><br><span class="line">    choices: [</span><br><span class="line">      &#123;</span><br><span class="line">        name: <span class="string">&#x27;Jest&#x27;</span>,</span><br><span class="line">        value: <span class="string">&#x27;jest&#x27;</span>,</span><br><span class="line">        short: <span class="string">&#x27;Jest&#x27;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        name: <span class="string">&#x27;Mocha + Chai (requires webpack 4)&#x27;</span>,</span><br><span class="line">        value: <span class="string">&#x27;mocha&#x27;</span>,</span><br><span class="line">        short: <span class="string">&#x27;Mocha&#x27;</span></span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  cli.onPromptComplete(<span class="function">(<span class="params">answers, options</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (answers.unit === <span class="string">&#x27;mocha&#x27;</span>) &#123;</span><br><span class="line">      options.plugins[<span class="string">&#x27;@vue/cli-plugin-unit-mocha&#x27;</span>] = &#123;&#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (answers.unit === <span class="string">&#x27;jest&#x27;</span>) &#123;</span><br><span class="line">      options.plugins[<span class="string">&#x27;@vue/cli-plugin-unit-jest&#x27;</span>] = &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>cli.injectFeature</code> 是注入 featurePrompt，即初始化项目时选择的勾选项如 babel，typescript，pwa 等等，如下图：</p>
<img src="/assets/vue-cli/07.png" width="500" />
<p><code>cli.injectPrompt</code> 是根据选择的 featurePrompt 然后注入对应的 prompt，当选择了 unit，接下来会有以下的 prompt，选择 Mocha + Chai 还是 Jest：</p>
<img src="/assets/vue-cli/08.png" width="500" />
<p><code>cli.onPromptComplete</code> 就是一个回调，会根据选择来添加对应的插件， 当选择了 mocha ，那么就会添加 @vue/cli-plugin-unit-mocha 插件。</p>
<p>接下来我们开始正式查看 Creator 类，打开一看，哦豁，554 行代码，12 个引入模块，告辞！</p>
<p>考虑到大家时间比较紧张（wo bi jiao lan）这儿梳理一下主要流程：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = <span class="class"><span class="keyword">class</span> <span class="title">Creator</span> <span class="keyword">extends</span> <span class="title">EventEmitter</span> </span>&#123;</span><br><span class="line">  <span class="title">constructor</span> (<span class="params">name, context, promptModules</span>) &#123;</span><br><span class="line">    <span class="built_in">super</span>()</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.name = name</span><br><span class="line">    <span class="built_in">this</span>.context = process.env.VUE_CLI_CONTEXT = context</span><br><span class="line">    <span class="comment">// 获取了 preset 和 feature 的交互选择列表，在 vue create 命令初始化项目的时候提供选择</span></span><br><span class="line">    <span class="keyword">const</span> &#123; presetPrompt, featurePrompt &#125; = <span class="built_in">this</span>.resolveIntroPrompts()</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.presetPrompt = presetPrompt <span class="comment">// preset 列表</span></span><br><span class="line">    <span class="built_in">this</span>.featurePrompt = featurePrompt <span class="comment">// pwa、babel、e2e等等</span></span><br><span class="line">    <span class="comment">// 存放项目配置的文件（package.json || congfig.js） 以及是否将 presetPrompts 存放起来</span></span><br><span class="line">    <span class="built_in">this</span>.outroPrompts = <span class="built_in">this</span>.resolveOutroPrompts()</span><br><span class="line">    <span class="built_in">this</span>.outroPrompts = [] <span class="comment">// 对应 feature 的 Prompts</span></span><br><span class="line">    <span class="comment">// 不同阶段回调函数列表</span></span><br><span class="line">    <span class="built_in">this</span>.promptCompleteCbs = []</span><br><span class="line">    <span class="built_in">this</span>.afterInvokeCbs = []</span><br><span class="line">    <span class="built_in">this</span>.afterAnyInvokeCbs = []</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.run = <span class="built_in">this</span>.run.bind(<span class="built_in">this</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> promptAPI = <span class="keyword">new</span> PromptModuleAPI(<span class="built_in">this</span>)</span><br><span class="line">    promptModules.forEach(<span class="function"><span class="params">m</span> =&gt;</span> m(promptAPI))</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这儿我们首先注意到构造函数中分别为实例对象添加了 presetPrompt、featurePrompt、outroPrompts、outroPrompts 等各种各样的 “prompt” 属性，那么它们之间有什么区别，又分别代表了什么呢？</p>
<ul>
<li>presetPrompt： 预设选项 prompt，加入上次以 Manually 模式进行了预设选项，并且保存到了 ~/.vuerc 中，那么在初始化项目时就会列出已经保存的 preset，并提供选择。</li>
<li>featurePrompt：项目的一些 feature，就是选择 babel，typescript，pwa，router，vuex，cssPreprocessors，linter，unit，e2e。</li>
<li>injectedPrompts：当选择了 feature 后，就会为对应的 feature 注入 prompts，比如你选择了 unit，那么就会让你选择模式： Mocha + Chai 还是 Jest</li>
<li>outroPrompts： 其他的 prompt，包含：
<ul>
<li>将 Babel, PostCSS, ESLint 等等的配置文件存放在 package.json 中还是存放在 config 文件中；</li>
<li>是否需要将这次设置的 preset 保存到本地，如果需要则会进一步让你输入名称进行保存；</li>
<li>安装依赖是选择 npm 还是 yarn。</li>
</ul>
</li>
</ul>
<p>再搞清了 “prompt” 之间的区别后我们接着往下看 PromptModuleAPI，其源码如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = <span class="class"><span class="keyword">class</span> <span class="title">PromptModuleAPI</span> </span>&#123;</span><br><span class="line">  <span class="title">constructor</span> (<span class="params">creator</span>) &#123;</span><br><span class="line">    <span class="built_in">this</span>.creator = creator</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  injectFeature (feature) &#123;</span><br><span class="line">    <span class="built_in">this</span>.creator.featurePrompt.choices.push(feature)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  injectPrompt (prompt) &#123;</span><br><span class="line">    <span class="built_in">this</span>.creator.injectedPrompts.push(prompt)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  injectOptionForPrompt (name, option) &#123;</span><br><span class="line">    <span class="built_in">this</span>.creator.injectedPrompts.find(<span class="function"><span class="params">f</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> f.name === name</span><br><span class="line">    &#125;).choices.push(option)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  onPromptComplete (cb) &#123;</span><br><span class="line">    <span class="built_in">this</span>.creator.promptCompleteCbs.push(cb)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>PromptModuleAPI 实例会调用它的实例方法，然后将 injectFeature，injectPrompt，injectOptionForPrompt，onPromptComplete 保存到 Creator 实例对应的变量中。最后遍历前面 getPromptModules 获取的 promptModules，传入实例 promptAPI，初始化 Creator 实例中 featurePrompt, injectedPrompts, promptCompleteCbs 变量。</p>
<p>在 <code>../lib/create.js</code> 文件中的 create 方法中我们生成 Creator 实例后调用了其 create 方法：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">await</span> creator.create(options)</span><br></pre></td></tr></table></figure>
<p>因此我们接着查看 create 方法的具体实现：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> create (cliOptions = &#123;&#125;, preset = <span class="literal">null</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> isTestOrDebug = process.env.VUE_CLI_TEST || process.env.VUE_CLI_DEBUG</span><br><span class="line">  <span class="keyword">const</span> &#123; run, name, context, afterInvokeCbs, afterAnyInvokeCbs &#125; = <span class="built_in">this</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!preset) &#123;</span><br><span class="line">    <span class="keyword">if</span> (cliOptions.preset) &#123;</span><br><span class="line">      <span class="comment">// vue create foo --preset bar</span></span><br><span class="line">      preset = <span class="keyword">await</span> <span class="built_in">this</span>.resolvePreset(cliOptions.preset, cliOptions.clone)</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cliOptions.default) &#123;</span><br><span class="line">      <span class="comment">// vue create foo --default</span></span><br><span class="line">      preset = defaults.presets.default</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cliOptions.inlinePreset) &#123;</span><br><span class="line">      <span class="comment">// vue create foo --inlinePreset &#123;...&#125;</span></span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        preset = <span class="built_in">JSON</span>.parse(cliOptions.inlinePreset)</span><br><span class="line">      &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">        error(<span class="string">`CLI inline preset is not valid JSON: <span class="subst">$&#123;cliOptions.inlinePreset&#125;</span>`</span>)</span><br><span class="line">        exit(<span class="number">1</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      preset = <span class="keyword">await</span> <span class="built_in">this</span>.promptAndResolvePreset()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// clone before mutating</span></span><br><span class="line">  preset = cloneDeep(preset)</span><br><span class="line">  <span class="comment">// inject core service</span></span><br><span class="line">  preset.plugins[<span class="string">&#x27;@vue/cli-service&#x27;</span>] = <span class="built_in">Object</span>.assign(&#123; <span class="comment">// 注入核心 @vue/cli-service</span></span><br><span class="line">    projectName: name</span><br><span class="line">  &#125;, preset, &#123;</span><br><span class="line">    bare: cliOptions.bare</span><br><span class="line">  &#125;)</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>先判断 vue create 命令是否带有 -p 选项，如果有的话会调用 resolvePreset 去解析 preset。resolvePreset 函数会先获取 <code>～/.vuerc</code> 中保存的 preset， 然后进行遍历，如果里面包含了 -p 中的 <code>&lt;presetName&gt;</code>，则返回 <code>～/.vuerc</code> 中的 preset。如果没有则判断是否是采用内联的 JSON 字符串预设选项，如果是就会解析 <code>.json</code> 文件，并返回 preset，还有一种情况就是从远程获取 preset（利用 download-git-repo 下载远程的 preset.json 并返回。</p>
<p>如果 vue create 命令没有带有 -p 选项就会调用 promptAndResolvePreset 函数利用 inquirer.prompt 以命令后交互的形式来获取 preset，下面看下 promptAndResolvePreset 函数的源码：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> promptAndResolvePreset (answers = <span class="literal">null</span>) &#123;</span><br><span class="line">  <span class="comment">// prompt</span></span><br><span class="line">  <span class="keyword">if</span> (!answers) &#123;</span><br><span class="line">    <span class="keyword">await</span> clearConsole(<span class="literal">true</span>)</span><br><span class="line">    answers = <span class="keyword">await</span> inquirer.prompt(<span class="built_in">this</span>.resolveFinalPrompts())</span><br><span class="line">  &#125;</span><br><span class="line">  debug(<span class="string">&#x27;vue-cli:answers&#x27;</span>)(answers)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (answers.packageManager) &#123;</span><br><span class="line">    saveOptions(&#123;</span><br><span class="line">      packageManager: answers.packageManager</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> preset</span><br><span class="line">  <span class="keyword">if</span> (answers.preset &amp;&amp; answers.preset !== <span class="string">&#x27;__manual__&#x27;</span>) &#123;</span><br><span class="line">    preset = <span class="keyword">await</span> <span class="built_in">this</span>.resolvePreset(answers.preset)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// manual</span></span><br><span class="line">    preset = &#123;</span><br><span class="line">      useConfigFiles: answers.useConfigFiles === <span class="string">&#x27;files&#x27;</span>,</span><br><span class="line">      plugins: &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">    answers.features = answers.features || []</span><br><span class="line">    <span class="comment">// run cb registered by prompt modules to finalize the preset</span></span><br><span class="line">    <span class="built_in">this</span>.promptCompleteCbs.forEach(<span class="function"><span class="params">cb</span> =&gt;</span> cb(answers, preset))</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// validate</span></span><br><span class="line">  validatePreset(preset)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// save preset</span></span><br><span class="line">  <span class="keyword">if</span> (answers.save &amp;&amp; answers.saveName &amp;&amp; savePreset(answers.saveName, preset)) &#123;</span><br><span class="line">    log()</span><br><span class="line">    log(<span class="string">`🎉  Preset <span class="subst">$&#123;chalk.yellow(answers.saveName)&#125;</span> saved in <span class="subst">$&#123;chalk.yellow(rcPath)&#125;</span>`</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  debug(<span class="string">&#x27;vue-cli:preset&#x27;</span>)(preset)</span><br><span class="line">  <span class="keyword">return</span> preset</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>代码首先利用 this.resolveFinalPrompts() 获取了最后的 prompts 并通过 inquirer.prompt 在命令行与用户交互，这儿的 resolveFinalPrompts 的实现如下所示：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">resolveFinalPrompts () &#123;</span><br><span class="line">  <span class="comment">// patch generator-injected prompts to only show in manual mode</span></span><br><span class="line">  <span class="comment">// 将所有的 Prompt 合并，包含 preset，feature，injected，outro，只有当选择了手动模式的时候才会显示 injectedPrompts</span></span><br><span class="line">  <span class="built_in">this</span>.injectedPrompts.forEach(<span class="function"><span class="params">prompt</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> originalWhen = prompt.when || (<span class="function">() =&gt;</span> <span class="literal">true</span>)</span><br><span class="line">    prompt.when = <span class="function"><span class="params">answers</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> isManualMode(answers) &amp;&amp; originalWhen(answers)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> prompts = [</span><br><span class="line">    <span class="built_in">this</span>.presetPrompt,</span><br><span class="line">    <span class="built_in">this</span>.featurePrompt,</span><br><span class="line">    ...this.injectedPrompts,</span><br><span class="line">    ...this.outroPrompts</span><br><span class="line">  ]</span><br><span class="line">  debug(<span class="string">&#x27;vue-cli:prompts&#x27;</span>)(prompts)</span><br><span class="line">  <span class="keyword">return</span> prompts</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>inquirer.prompt 执行完成后会返回 answers，如果选择了本地保存的 preset 或者 default，则调用 resolvePreset 进行解析 preset，否则遍历 promptCompleteCbs 执行 injectFeature 和 injectPrompt 的回调，将对应的插件赋值到 options.plugins 中，以 unit 为例：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cli.onPromptComplete(<span class="function">(<span class="params">answers, options</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (answers.unit === <span class="string">&#x27;mocha&#x27;</span>) &#123;</span><br><span class="line">    options.plugins[<span class="string">&#x27;@vue/cli-plugin-unit-mocha&#x27;</span>] = &#123;&#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (answers.unit === <span class="string">&#x27;jest&#x27;</span>) &#123;</span><br><span class="line">    options.plugins[<span class="string">&#x27;@vue/cli-plugin-unit-jest&#x27;</span>] = &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>如果 feature 选择了 unit，并且 unit 模式选择的是 Mocha + Chai，则添加 @vue/cli-plugin-unit-mocha 插件，如果选择的是 Jest 则添加 @vue/cli-plugin-unit-jest 插件。</p>
<p>我们接着查看 create 方法在获取到 preset 之后，还会向 preset 的插件里面注入核心插件 <code>@vue/cli-service</code>， 它是调用 <code>vue-cli-service &lt;command&gt; [...args]</code> 时创建的类。 负责管理内部的 webpack 配置、暴露服务和构建项目的命令等。</p>
<p>至此我们已经完成了 vue create 命令执行过程中第一个要点：<strong>获取用户配置信息</strong>，并且根据配置信息获取了所需的插件，接下来便是另一个核心<strong>依赖的安装</strong>，我们来接着看 create 函数：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> create (cliOptions = &#123;&#125;, preset = <span class="literal">null</span>) &#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">const</span> packageManager = (</span><br><span class="line">    cliOptions.packageManager ||</span><br><span class="line">    loadOptions().packageManager ||</span><br><span class="line">    (hasYarn() ? <span class="string">&#x27;yarn&#x27;</span> : <span class="literal">null</span>) ||</span><br><span class="line">    (hasPnpm3OrLater() ? <span class="string">&#x27;pnpm&#x27;</span> : <span class="string">&#x27;npm&#x27;</span>)</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">  <span class="keyword">await</span> clearConsole()</span><br><span class="line">  <span class="keyword">const</span> pm = <span class="keyword">new</span> PackageManager(&#123; context, <span class="attr">forcePackageManager</span>: packageManager &#125;)</span><br><span class="line"></span><br><span class="line">  log(<span class="string">`✨  Creating project in <span class="subst">$&#123;chalk.yellow(context)&#125;</span>.`</span>)</span><br><span class="line">  <span class="built_in">this</span>.emit(<span class="string">&#x27;creation&#x27;</span>, &#123; <span class="attr">event</span>: <span class="string">&#x27;creating&#x27;</span> &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// get latest CLI plugin version</span></span><br><span class="line">  <span class="keyword">const</span> &#123; latestMinor &#125; = <span class="keyword">await</span> getVersions()</span><br><span class="line">  <span class="comment">// generate package.json with plugin dependencies</span></span><br><span class="line">  <span class="keyword">const</span> pkg = &#123;</span><br><span class="line">    name,</span><br><span class="line">    version: <span class="string">&#x27;0.1.0&#x27;</span>,</span><br><span class="line">    private: <span class="literal">true</span>,</span><br><span class="line">    devDependencies: &#123;&#125;,</span><br><span class="line">    ...resolvePkg(context)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> deps = <span class="built_in">Object</span>.keys(preset.plugins)</span><br><span class="line">  deps.forEach(<span class="function"><span class="params">dep</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (preset.plugins[dep]._isPreset) &#123;</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> &#123; version &#125; = preset.plugins[dep]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!version) &#123;</span><br><span class="line">      <span class="keyword">if</span> (isOfficialPlugin(dep) || dep === <span class="string">&#x27;@vue/cli-service&#x27;</span> || dep === <span class="string">&#x27;@vue/babel-preset-env&#x27;</span>) &#123;</span><br><span class="line">        version = isTestOrDebug ? <span class="string">`latest`</span> : <span class="string">`~<span class="subst">$&#123;latestMinor&#125;</span>`</span></span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        version = <span class="string">&#x27;latest&#x27;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    pkg.devDependencies[dep] = version</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// write package.json</span></span><br><span class="line">  <span class="keyword">await</span> writeFileTree(context, &#123;</span><br><span class="line">    <span class="string">&#x27;package.json&#x27;</span>: <span class="built_in">JSON</span>.stringify(pkg, <span class="literal">null</span>, <span class="number">2</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>此处代码主要有两处作用：<strong>获取最新 CLI （包含插件）的版本</strong> 和 <strong>生成 package.json</strong>，这里 getVersions 方法用于判断 @vue/cli 是否需要更新以及初始化项目中相关插件的版本，需要注意的是，getVersions 获取 CLI 的版本并不是直接获取， 而是通过 <code>vue-cli-version-marker</code> npm 包获取的 CLI 版本，为什么会这样做，主要原因有两点：</p>
<ul>
<li>vue-cli 从 3.0（@vue/cli） 开始就放在了 @vue 下面，即是一个 scoped package, 而 <strong>scoped package 又不支持通过 npm registry 来获取 latest 版本信息</strong>。比如 vue-cli-version-marker/latest 可以正常访问，而 @vue/cli/latest 则不可以。</li>
<li>获取 scoped packages 的数据比获取 unscoped package 通常要慢 300ms。</li>
</ul>
<p>正是由于上述两个原因，因此通过 unscoped package <code>vue-cli-version-marker</code> 来获取 CLI 版本，<code>vue-cli-version-marker</code> 的内容比较简单，就是一个 package.json，通过获取里面 devDependencies 的版本信息，从而获取 @vue/cli 以及一些插件的版本号。</p>
<p>获取了插件版本之后遍历 preset 中所有 plugin 为其初始化版本号。并调用 writeFileTree 生成 package.json 。</p>
<p>在生成 package.json 文件之后便开始依赖的正式安装，在这之前会先进行判断是否需要 git 初始化：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> create (cliOptions = &#123;&#125;, preset = <span class="literal">null</span>) &#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="comment">// intilaize git repository before installing deps</span></span><br><span class="line">  <span class="comment">// so that vue-cli-service can setup git hooks.</span></span><br><span class="line">  <span class="keyword">const</span> shouldInitGit = <span class="built_in">this</span>.shouldInitGit(cliOptions)</span><br><span class="line">  <span class="keyword">if</span> (shouldInitGit) &#123;</span><br><span class="line">    log(<span class="string">`🗃  Initializing git repository...`</span>)</span><br><span class="line">    <span class="built_in">this</span>.emit(<span class="string">&#x27;creation&#x27;</span>, &#123; <span class="attr">event</span>: <span class="string">&#x27;git-init&#x27;</span> &#125;)</span><br><span class="line">    <span class="keyword">await</span> run(<span class="string">&#x27;git init&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// install plugins</span></span><br><span class="line">  log(<span class="string">`⚙\u&#123;fe0f&#125;  Installing CLI plugins. This might take a while...`</span>)</span><br><span class="line">  log()</span><br><span class="line">  <span class="built_in">this</span>.emit(<span class="string">&#x27;creation&#x27;</span>, &#123; <span class="attr">event</span>: <span class="string">&#x27;plugins-install&#x27;</span> &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (isTestOrDebug &amp;&amp; !process.env.VUE_CLI_TEST_DO_INSTALL_PLUGIN) &#123;</span><br><span class="line">    <span class="comment">// in development, avoid installation process</span></span><br><span class="line">    <span class="keyword">await</span> <span class="built_in">require</span>(<span class="string">&#x27;./util/setupDevProject&#x27;</span>)(context)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">await</span> pm.install()</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这段代码会先调用 shouldInitGit 来判断是否需要 git 初始化，判断的情形有以下几种：</p>
<ul>
<li>没有安装 git (!hasGit())：false；</li>
<li>vue create 含有 --git 或者 -g 选项：true；</li>
<li>vue create 含有 --no-git 或者 -n 选项：false；</li>
<li>生成项目的目录是否已经含有 git （!hasProjectGit(this.context)）：如果有，则返回 false，否则返回 true。</li>
</ul>
<p>在判断完是否需要 git 初始化项目后，接下来就会调用 <code>pm.install</code> 安装依赖，还是看下其源码：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> install () &#123;</span><br><span class="line">  <span class="keyword">const</span> args = []</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">this</span>.needsPeerDepsFix) &#123;</span><br><span class="line">    args.push(<span class="string">&#x27;--legacy-peer-deps&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (process.env.VUE_CLI_TEST) &#123;</span><br><span class="line">    args.push(<span class="string">&#x27;--silent&#x27;</span>, <span class="string">&#x27;--no-progress&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">await</span> <span class="built_in">this</span>.runCommand(<span class="string">&#x27;install&#x27;</span>, args)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">async</span> runCommand (command, args) &#123;</span><br><span class="line">  <span class="keyword">const</span> prevNodeEnv = process.env.NODE_ENV</span><br><span class="line">  <span class="comment">// In the use case of Vue CLI, when installing dependencies,</span></span><br><span class="line">  <span class="comment">// the `NODE_ENV` environment variable does no good;</span></span><br><span class="line">  <span class="comment">// it only confuses users by skipping dev deps (when set to `production`).</span></span><br><span class="line">  <span class="keyword">delete</span> process.env.NODE_ENV</span><br><span class="line"></span><br><span class="line">  <span class="keyword">await</span> <span class="built_in">this</span>.setRegistryEnvs()</span><br><span class="line">  <span class="keyword">await</span> executeCommand(</span><br><span class="line">    <span class="built_in">this</span>.bin,</span><br><span class="line">    [</span><br><span class="line">      ...PACKAGE_MANAGER_CONFIG[<span class="built_in">this</span>.bin][command],</span><br><span class="line">      ...(args || [])</span><br><span class="line">    ],</span><br><span class="line">    <span class="built_in">this</span>.context</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (prevNodeEnv) &#123;</span><br><span class="line">    process.env.NODE_ENV = prevNodeEnv</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>源码中调用了 setRegistryEnvs 函数，它的作用是指定安装源，具体实现如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Any command that implemented registry-related feature should support</span></span><br><span class="line"><span class="comment">// `-r` / `--registry` option</span></span><br><span class="line"><span class="keyword">async</span> getRegistry (scope) &#123;</span><br><span class="line">  <span class="keyword">const</span> cacheKey = scope || <span class="string">&#x27;&#x27;</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">this</span>._registries[cacheKey]) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>._registries[cacheKey]</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> args = minimist(process.argv, &#123;</span><br><span class="line">    alias: &#123;</span><br><span class="line">      r: <span class="string">&#x27;registry&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> registry</span><br><span class="line">  <span class="keyword">if</span> (args.registry) &#123;</span><br><span class="line">    registry = args.registry</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!process.env.VUE_CLI_TEST &amp;&amp; <span class="keyword">await</span> shouldUseTaobao(<span class="built_in">this</span>.bin)) &#123;</span><br><span class="line">    registry = registries.taobao</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (scope) &#123;</span><br><span class="line">        registry = (<span class="keyword">await</span> execa(<span class="built_in">this</span>.bin, [<span class="string">&#x27;config&#x27;</span>, <span class="string">&#x27;get&#x27;</span>, scope + <span class="string">&#x27;:registry&#x27;</span>])).stdout</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (!registry || registry === <span class="string">&#x27;undefined&#x27;</span>) &#123;</span><br><span class="line">        registry = (<span class="keyword">await</span> execa(<span class="built_in">this</span>.bin, [<span class="string">&#x27;config&#x27;</span>, <span class="string">&#x27;get&#x27;</span>, <span class="string">&#x27;registry&#x27;</span>])).stdout</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">      <span class="comment">// Yarn 2 uses `npmRegistryServer` instead of `registry`</span></span><br><span class="line">      registry = (<span class="keyword">await</span> execa(<span class="built_in">this</span>.bin, [<span class="string">&#x27;config&#x27;</span>, <span class="string">&#x27;get&#x27;</span>, <span class="string">&#x27;npmRegistryServer&#x27;</span>])).stdout</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">this</span>._registries[cacheKey] = stripAnsi(registry).trim()</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">this</span>._registries[cacheKey]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>示例中如果 vue create 还有 -r 选项则采用设置的安装源，否则调用 shouldUseTaobao 函数来判断是否需要使用淘宝 NPM 镜像源，如果两者都不匹配则会调用 <a target="_blank" rel="noopener" href="https://www.npmjs.com/package/execa">execa</a> 来直接执行 <code>this.bin</code> 文件，这儿的 bin 属性实际上就是 PackageManager 类创建的时候传入的 forcePackageManager 参数，即 yarn / npm / pnpm，在选定安装源后紧接着调用 executeCommand 函数，executeCommand 函数利用了 execa 执行 npm 或者 yarn 安装命令。至此<strong>安装依赖</strong>的流程就全部结束了，接下来就是 <code>vue create</code> 最核心的部分<strong>代码生成</strong>：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> create (cliOptions = &#123;&#125;, preset = <span class="literal">null</span>) &#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="comment">// run generator</span></span><br><span class="line">  log(<span class="string">`🚀  Invoking generators...`</span>)</span><br><span class="line">  <span class="built_in">this</span>.emit(<span class="string">&#x27;creation&#x27;</span>, &#123; <span class="attr">event</span>: <span class="string">&#x27;invoking-generators&#x27;</span> &#125;)</span><br><span class="line">  <span class="keyword">const</span> plugins = <span class="keyword">await</span> <span class="built_in">this</span>.resolvePlugins(preset.plugins, pkg)</span><br><span class="line">  <span class="keyword">const</span> generator = <span class="keyword">new</span> Generator(context, &#123;</span><br><span class="line">    pkg,</span><br><span class="line">    plugins,</span><br><span class="line">    afterInvokeCbs,</span><br><span class="line">    afterAnyInvokeCbs</span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="keyword">await</span> generator.generate(&#123;</span><br><span class="line">    extractConfigFiles: preset.useConfigFiles</span><br><span class="line">  &#125;)</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>示例中在实例化 Generator 实例之前调用了 resolvePlugins 对插件进行初始化，举个例子：<code>[&#123; '@vue/cli-plugin-babel': &#123; useTsWithBabel: true &#125; &#125;]</code> 的入参将被转化生成 <code>[&#123; id: '@vue/cli-plugin-babel', apply, options: &#123; useTsWithBabel: true &#125;&#125;]</code>，这儿主要的不同是多了 apply 对象，实际上了对应插件下 <code>generator</code> 文件的加载对象，在示例中也就是 <code>@vue/cli-plugin-babel/generator</code> 文件。</p>
<p>再完成了对插件的初始化和每个插件下的 <code>generator.js</code> 文件的加载后正式开始 Generator 实例的创建，在实例化一个 Generator 的时候会初始化一些成员变量，最重要的就是调用插件的 generators，不同于 1.x/2.x 基于模板的脚手架，Vue-cli3.0 采用了一套 基于插件的架构，到这里就会交给各个插件去执行了，看一下 Generator 实例化的代码：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = <span class="class"><span class="keyword">class</span> <span class="title">Generator</span> </span>&#123;</span><br><span class="line">  <span class="title">constructor</span> (<span class="params">context, &#123;</span></span><br><span class="line"><span class="params">    pkg = &#123;&#125;,</span></span><br><span class="line"><span class="params">    plugins = [],</span></span><br><span class="line"><span class="params">    afterInvokeCbs = [],</span></span><br><span class="line"><span class="params">    afterAnyInvokeCbs = [],</span></span><br><span class="line"><span class="params">    files = &#123;&#125;,</span></span><br><span class="line"><span class="params">    invoking = <span class="literal">false</span></span></span><br><span class="line"><span class="params">  &#125; = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="built_in">this</span>.context = context</span><br><span class="line">    <span class="built_in">this</span>.plugins = plugins</span><br><span class="line">    <span class="built_in">this</span>.originalPkg = pkg</span><br><span class="line">    <span class="built_in">this</span>.pkg = <span class="built_in">Object</span>.assign(&#123;&#125;, pkg)</span><br><span class="line">    <span class="built_in">this</span>.pm = <span class="keyword">new</span> PackageManager(&#123; context &#125;)</span><br><span class="line">    <span class="built_in">this</span>.imports = &#123;&#125;</span><br><span class="line">    <span class="built_in">this</span>.rootOptions = &#123;&#125;</span><br><span class="line">    <span class="built_in">this</span>.afterInvokeCbs = afterInvokeCbs</span><br><span class="line">    <span class="built_in">this</span>.afterAnyInvokeCbs = afterAnyInvokeCbs</span><br><span class="line">    <span class="built_in">this</span>.configTransforms = &#123;&#125; <span class="comment">// 插件通过 GeneratorAPI 暴露的 addConfigTransform 方法添加如何提取配置文件</span></span><br><span class="line">    <span class="built_in">this</span>.defaultConfigTransforms = defaultConfigTransforms <span class="comment">// 默认的配置文件</span></span><br><span class="line">    <span class="built_in">this</span>.reservedConfigTransforms = reservedConfigTransforms <span class="comment">// 保留的配置文件 vue.config.js</span></span><br><span class="line">    <span class="built_in">this</span>.invoking = invoking</span><br><span class="line">    <span class="comment">// for conflict resolution</span></span><br><span class="line">    <span class="built_in">this</span>.depSources = &#123;&#125;</span><br><span class="line">    <span class="comment">// virtual file tree</span></span><br><span class="line">    <span class="built_in">this</span>.files = <span class="built_in">Object</span>.keys(files).length</span><br><span class="line">      <span class="comment">// when execute `vue add/invoke`, only created/modified files are written to disk</span></span><br><span class="line">      ? watchFiles(files, <span class="built_in">this</span>.filesModifyRecord = <span class="keyword">new</span> <span class="built_in">Set</span>())</span><br><span class="line">      <span class="comment">// all files need to be written to disk</span></span><br><span class="line">      : files</span><br><span class="line">    <span class="built_in">this</span>.fileMiddlewares = []</span><br><span class="line">    <span class="built_in">this</span>.postProcessFilesCbs = []</span><br><span class="line">    <span class="comment">// exit messages</span></span><br><span class="line">    <span class="built_in">this</span>.exitLogs = []</span><br><span class="line"></span><br><span class="line">    <span class="comment">// load all the other plugins</span></span><br><span class="line">    <span class="built_in">this</span>.allPluginIds = <span class="built_in">Object</span>.keys(<span class="built_in">this</span>.pkg.dependencies || &#123;&#125;)</span><br><span class="line">      .concat(<span class="built_in">Object</span>.keys(<span class="built_in">this</span>.pkg.devDependencies || &#123;&#125;))</span><br><span class="line">      .filter(isPlugin)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> cliService = plugins.find(<span class="function"><span class="params">p</span> =&gt;</span> p.id === <span class="string">&#x27;@vue/cli-service&#x27;</span>)</span><br><span class="line">    <span class="keyword">const</span> rootOptions = cliService</span><br><span class="line">      ? cliService.options</span><br><span class="line">      : inferRootOptions(pkg)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.rootOptions = rootOptions</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后查看其具体被调用实例的 generate 方法：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> generate (&#123;</span><br><span class="line">  extractConfigFiles = <span class="literal">false</span>,</span><br><span class="line">  checkExisting = <span class="literal">false</span></span><br><span class="line">&#125; = &#123;&#125;) &#123;</span><br><span class="line">  <span class="keyword">await</span> <span class="built_in">this</span>.initPlugins()</span><br><span class="line"></span><br><span class="line">  <span class="comment">// save the file system before applying plugin for comparison</span></span><br><span class="line">  <span class="keyword">const</span> initialFiles = <span class="built_in">Object</span>.assign(&#123;&#125;, <span class="built_in">this</span>.files)</span><br><span class="line">  <span class="comment">// extract configs from package.json into dedicated files.</span></span><br><span class="line">  <span class="built_in">this</span>.extractConfigFiles(extractConfigFiles, checkExisting)</span><br><span class="line">  <span class="comment">// wait for file resolve</span></span><br><span class="line">  <span class="keyword">await</span> <span class="built_in">this</span>.resolveFiles()</span><br><span class="line">  <span class="comment">// set package.json</span></span><br><span class="line">  <span class="built_in">this</span>.sortPkg()</span><br><span class="line">  <span class="built_in">this</span>.files[<span class="string">&#x27;package.json&#x27;</span>] = <span class="built_in">JSON</span>.stringify(<span class="built_in">this</span>.pkg, <span class="literal">null</span>, <span class="number">2</span>) + <span class="string">&#x27;\n&#x27;</span></span><br><span class="line">  <span class="comment">// write/update file tree to disk</span></span><br><span class="line">  <span class="keyword">await</span> writeFileTree(<span class="built_in">this</span>.context, <span class="built_in">this</span>.files, initialFiles, <span class="built_in">this</span>.filesModifyRecord)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这儿 initPlugins 的主要作用是为每个插件对应生成一个 GeneratorAPI 实例，同时将实例作为参数传递给前面插件初始化时生成的插件下 <code>generator</code> 文件的加载对象，也可以理解为将实例 api 传入插件暴露出来的 generator 函数，这儿的最重要的就是 GeneratorAPI 了。</p>
<p>前面说到 Vue CLI 是基于一套插件架构的，那么如果插件需要自定义项目模板、修改模板中的一些文件或者添加一些依赖的话怎么处理呢？方法是 @vue/cli 插件所提供的 generator 向外暴露一个函数，接收的第一个参数 api，然后通过该 api 提供的方法去完成应用的拓展工作，这里所说 的 api 就是 GeneratorAPI，下面看一下 GeneratorAPI 提供了哪些方法。</p>
<ul>
<li>hasPlugin：判断项目中是否有某个插件</li>
<li>extendPackage：拓展 package.json 配置</li>
<li>render：利用 ejs 渲染模板文件</li>
<li>onCreateComplete：内存中保存的文件字符串全部被写入文件后的回调函数</li>
<li>exitLog：当 generator 退出的时候输出的信息</li>
<li>genJSConfig：将 json 文件生成为 js 配置文件</li>
<li>injectImports：向文件当中注入import语法的方法</li>
<li>injectRootOptions：向 Vue 根实例中添加选项</li>
<li>…</li>
</ul>
<p>下面以 <code>@vue/cli-service/generator/index.js</code> 为例：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = <span class="function">(<span class="params">api, options</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">/* 渲染 ejs 模板 */</span></span><br><span class="line">  api.render(<span class="string">&#x27;./template&#x27;</span>, &#123;</span><br><span class="line">    doesCompile: api.hasPlugin(<span class="string">&#x27;babel&#x27;</span>) || api.hasPlugin(<span class="string">&#x27;typescript&#x27;</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 扩展 package.json</span></span><br><span class="line">  api.extendPackage(&#123;</span><br><span class="line">    scripts: &#123;</span><br><span class="line">      <span class="string">&#x27;serve&#x27;</span>: <span class="string">&#x27;vue-cli-service serve&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;build&#x27;</span>: <span class="string">&#x27;vue-cli-service build&#x27;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    dependencies: &#123;</span><br><span class="line">      <span class="string">&#x27;vue&#x27;</span>: <span class="string">&#x27;^2.5.17&#x27;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    devDependencies: &#123;</span><br><span class="line">      <span class="string">&#x27;vue-template-compiler&#x27;</span>: <span class="string">&#x27;^2.5.17&#x27;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&#x27;postcss&#x27;</span>: &#123;</span><br><span class="line">      <span class="string">&#x27;plugins&#x27;</span>: &#123;</span><br><span class="line">        <span class="string">&#x27;autoprefixer&#x27;</span>: &#123;&#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    browserslist: [</span><br><span class="line">      <span class="string">&#x27;&gt; 1%&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;last 2 versions&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;not ie &lt;= 8&#x27;</span></span><br><span class="line">    ]</span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="comment">// 如果 preset 中包含 vue-router</span></span><br><span class="line">  <span class="keyword">if</span> (options.router) &#123;</span><br><span class="line">    <span class="built_in">require</span>(<span class="string">&#x27;./router&#x27;</span>)(api, options)</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 如果 preset 中包含 vuex</span></span><br><span class="line">  <span class="keyword">if</span> (options.vuex) &#123;</span><br><span class="line">    <span class="built_in">require</span>(<span class="string">&#x27;./vuex&#x27;</span>)(api, options)</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 如果 preset 中包含 cssPreprocessor，即选择了 css 预处理器</span></span><br><span class="line">  <span class="keyword">if</span> (options.cssPreprocessor) &#123;</span><br><span class="line">    <span class="keyword">const</span> deps = &#123;</span><br><span class="line">      sass: &#123;</span><br><span class="line">        <span class="string">&#x27;node-sass&#x27;</span>: <span class="string">&#x27;^4.9.0&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;sass-loader&#x27;</span>: <span class="string">&#x27;^7.0.1&#x27;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      less: &#123;</span><br><span class="line">        <span class="string">&#x27;less&#x27;</span>: <span class="string">&#x27;^3.0.4&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;less-loader&#x27;</span>: <span class="string">&#x27;^4.1.0&#x27;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      stylus: &#123;</span><br><span class="line">        <span class="string">&#x27;stylus&#x27;</span>: <span class="string">&#x27;^0.54.5&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;stylus-loader&#x27;</span>: <span class="string">&#x27;^3.0.2&#x27;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    api.extendPackage(&#123;</span><br><span class="line">      devDependencies: deps[options.cssPreprocessor]</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// additional tooling configurations</span></span><br><span class="line">  <span class="keyword">if</span> (options.configs) &#123;</span><br><span class="line">    api.extendPackage(options.configs)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过示例我们可以感受到 vue-cli 3.0 的插件机制的核心：<strong>通过 GeneratorAPI 所暴露的方法将所有功能都交给插件去完成</strong>。对于 vue-cli 3.0 内置的插件，比如：@vue/cli-plugin-eslint 、@vue/cli-plugin-pwa 等等，以及其他第三方插件，他们的 generator 作用都是一样都可以向项目的 package.json 中注入额外的依赖或字段，并向项目中添加文件。我们也可以结合 GeneratorAPI 所暴露的方法自定义插件，因此 vue-cli 3.0 的插件机制给予了我们极大的灵活性与扩展性。</p>
<p>在完成对每个插件的处理之后开始进入到了<strong>生成项目文件</strong>的阶段，大致可以分为三部分，<strong>extractConfigFiles（提取配置文件）</strong>，<strong>resolveFiles（模板渲染）</strong> 和 <strong>writeFileTree（在磁盘上生成文件）</strong>。</p>
<p>1、 extractConfigFiles</p>
<p>提取配置文件指的是将一些插件（比如 eslint，babel）的配置从 package.json 的字段中提取到专属的配置文件中。下面以 eslint 为例进行分析： 在初始化项目的时候，如果选择了 eslint 插件，在调用 @vue/cli-plugin-eslint 的 generator 的时候，就会向 package.json 注入 eslintConfig 字段：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = <span class="function">(<span class="params">api, &#123; config, lintOn = [] &#125;, _, invoking</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> lintOn === <span class="string">&#x27;string&#x27;</span>) &#123;</span><br><span class="line">    lintOn = lintOn.split(<span class="string">&#x27;,&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> eslintConfig = <span class="built_in">require</span>(<span class="string">&#x27;../eslintOptions&#x27;</span>).config(api)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> pkg = &#123;</span><br><span class="line">    scripts: &#123;</span><br><span class="line">      lint: <span class="string">&#x27;vue-cli-service lint&#x27;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    eslintConfig,</span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span></span></span><br><span class="line">    <span class="comment">// Move these dependencies to package.json in v4.</span></span><br><span class="line">    <span class="comment">// Now in v3 we have to add redundant eslint related dependencies</span></span><br><span class="line">    <span class="comment">// in order to keep compatibility with v3.0.x users who defaults to ESlint v4.</span></span><br><span class="line">    devDependencies: &#123;</span><br><span class="line">      <span class="string">&#x27;babel-eslint&#x27;</span>: <span class="string">&#x27;^10.0.1&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;eslint&#x27;</span>: <span class="string">&#x27;^5.8.0&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;esliint-plugin-vue&#x27;</span>: <span class="string">&#x27;^5.0.0-0&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> injectEditorConfig = <span class="function">(<span class="params">config</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> filePath = api.resolve(<span class="string">&#x27;.editorconfig&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> (fs.existsSync(filePath)) &#123;</span><br><span class="line">      <span class="comment">// Append to existing .editorconfig</span></span><br><span class="line">      api.render(<span class="function"><span class="params">files</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> configPath = path.resolve(__dirname, <span class="string">`./template/<span class="subst">$&#123;config&#125;</span>/_editorconfig`</span>)</span><br><span class="line">        <span class="keyword">const</span> editorconfig = fs.readFileSync(configPath, <span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        files[<span class="string">&#x27;.editorconfig&#x27;</span>] += <span class="string">`\n<span class="subst">$&#123;editorconfig&#125;</span>`</span></span><br><span class="line">      &#125;)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      api.render(<span class="string">`./template/<span class="subst">$&#123;config&#125;</span>`</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (config === <span class="string">&#x27;airbnb&#x27;</span>) &#123;</span><br><span class="line">    eslintConfig.extends.push(<span class="string">&#x27;@vue/airbnb&#x27;</span>)</span><br><span class="line">    <span class="built_in">Object</span>.assign(pkg.devDependencies, &#123;</span><br><span class="line">      <span class="string">&#x27;@vue/eslint-config-airbnb&#x27;</span>: <span class="string">&#x27;^4.0.0&#x27;</span></span><br><span class="line">    &#125;)</span><br><span class="line">    injectEditorConfig(<span class="string">&#x27;airbnb&#x27;</span>)</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (config === <span class="string">&#x27;standard&#x27;</span>) &#123;</span><br><span class="line">    eslintConfig.extends.push(<span class="string">&#x27;@vue/standard&#x27;</span>)</span><br><span class="line">    <span class="built_in">Object</span>.assign(pkg.devDependencies, &#123;</span><br><span class="line">      <span class="string">&#x27;@vue/eslint-config-standard&#x27;</span>: <span class="string">&#x27;^4.0.0&#x27;</span></span><br><span class="line">    &#125;)</span><br><span class="line">    injectEditorConfig(<span class="string">&#x27;standard&#x27;</span>)</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (config === <span class="string">&#x27;prettier&#x27;</span>) &#123;</span><br><span class="line">    eslintConfig.extends.push(<span class="string">&#x27;@vue/prettier&#x27;</span>)</span><br><span class="line">    <span class="built_in">Object</span>.assign(pkg.devDependencies, &#123;</span><br><span class="line">      <span class="string">&#x27;@vue/eslint-config-prettier&#x27;</span>: <span class="string">&#x27;^4.0.0&#x27;</span></span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="comment">// prettier &amp; default config do not have any style rules</span></span><br><span class="line">    <span class="comment">// so no need to generate an editorconfig file</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// default</span></span><br><span class="line">    eslintConfig.extends.push(<span class="string">&#x27;eslint:recommended&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  api.extendPackage(pkg)</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这是 <code>@vue/cli-plugin-eslint/generator/index.js</code> 中的一部分代码，从代码中可以看出，利用 GeneratorAPI 的 extendPackage 方法向 package.josn 里面注入了 scripts，eslintConfig 以及 devDependencies 字段，另外也会根据选择的 eslint 模式添加对应的依赖和修改对应的配置文件，例如选择了 airbnb 模式，就会向 eslintConfig.extends 添加 @vue/airbnb 配置，并且添加 @vue/eslint-config-airbnb 依赖和修改 .editorconfig 配置文件。此时 项目 package.json 中 eslintConfig 字段内容如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line"><span class="attr">&quot;eslintConfig&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;root&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">&quot;env&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;node&quot;</span>: <span class="literal">true</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;extends&quot;</span>: [</span><br><span class="line">      <span class="string">&quot;plugin:vue/essential&quot;</span>,</span><br><span class="line">      <span class="string">&quot;@vue/airbnb&quot;</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">&quot;rules&quot;</span>: &#123;&#125;,</span><br><span class="line">    <span class="attr">&quot;parserOptions&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;parser&quot;</span>: <span class="string">&quot;babel-eslint&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果 preset 的 useConfigFiles 为 true ，或者以 Manually 模式初始化 preset 的时候选择 In dedicated config files 存放配置文件，那么 extractConfigFiles 方法就会将 package.json 中 eslintConfig 字段内容提取到 .eslintrc.js 文件中，内存中 .eslintrc.js 内容如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  root: <span class="literal">true</span>,</span><br><span class="line">  env: &#123;</span><br><span class="line">    node: <span class="literal">true</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="keyword">extends</span>: [</span><br><span class="line">    <span class="string">&#x27;plugin:vue/essential&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;@vue/airbnb&#x27;</span>,</span><br><span class="line">  ],</span><br><span class="line">  rules: &#123;</span><br><span class="line">    <span class="string">&#x27;no-console&#x27;</span>: process.env.NODE_ENV === <span class="string">&#x27;production&#x27;</span> ? <span class="string">&#x27;error&#x27;</span> : <span class="string">&#x27;off&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;no-debugger&#x27;</span>: process.env.NODE_ENV === <span class="string">&#x27;production&#x27;</span> ? <span class="string">&#x27;error&#x27;</span> : <span class="string">&#x27;off&#x27;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  parserOptions: &#123;</span><br><span class="line">    parser: <span class="string">&#x27;babel-eslint&#x27;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>extractConfigFiles 方法的具体实现主要是调用 ConfigTransform 实例的 transform 方法，代码实现的比较清晰，各位同学可以自己看下。这里就不做详细 分析了，在配置文件提取完了以后接下来就是执行 resolveFiles 函数了。</p>
<p>2、 resolveFiles</p>
<p>resolveFiles 主要分为以下三个部分执行：</p>
<ul>
<li>fileMiddlewares</li>
<li>injectImportsAndOptions</li>
<li>postProcessFilesCbs</li>
</ul>
<p>fileMiddlewares 里面包含了 ejs render 函数，所有插件调用 api.render 时候只是把对应的渲染函数 push 到了 fileMiddlewares 中，等所有的 插件执行完以后才会遍历执行 fileMiddlewares 里面的所有函数，即在内存中生成模板文件字符串。</p>
<p>injectImportsAndOptions 就是将 generator 注入的 import 和 rootOption 解析到对应的文件中，比如选择了 vuex, 会在 src/main.js 中添加 import store from ‘./store’，以及在 vue 根实例中添加 router 选项。</p>
<p>postProcessFilesCbs 是在所有普通文件在内存中渲染成字符串完成之后要执行的遍历回调。例如将 @vue/cli-service/generator/index.js 中的 render 是放在了 fileMiddlewares 里面，而将 @vue/cli-service/generator/router/index.js 中将替换 src/App.vue 文件的方法放在了 postProcessFiles 里面，原因是对 src/App.vue 文件的一些替换一定是发生在 render 函数之后，如果在之前，修改后的 src/App.vue 在之后 render 函数执行时又会被覆盖，这样显然不合理。</p>
<p>3、 writeFileTree</p>
<p>在提取了配置文件和模板渲染之后调用了 sortPkg 对 package.json 的字段进行了排序并将 package.json 转化为 json 字符串添加到项目的 files 中。 此时整个项目的文件已经在内存中生成好了（在源码中就是对应的 this.files），接下来就调用 writeFileTree 方法将内存中的字符串模板文件生成在磁盘中。到这里 vue create 核心部分 generator 基本上就分析完了。</p>
<img src="/assets/emoji/04.png" width="280" />
<p>接下来在 <code>../lib/Creator.js</code> 文件的 create 方法中还有一些其他额外处理，主要包括：</p>
<ul>
<li>安装额外依赖：这里的依赖来源于 preset 的 option，比如选择了 scss css 预处理器，那么就需要额外安装 node-sass 和 sass-loader 两个依赖。</li>
<li>执行 createCompleteCbs：所有文件都写在磁盘后执行的遍历回调。</li>
<li>生成 <a target="_blank" rel="noopener" href="http://README.md">README.md</a>：根据 package.json 的 script 的字段生成生成对应的 <a target="_blank" rel="noopener" href="http://README.md">README.md</a>。</li>
<li>git 初始化提交：调用 shouldInitGit 来判断是否需要 git 初始化提交，如果需要初始化提交就会执行 git add 和 git commmit 命令。</li>
<li>日志输出：插件的 generator 可以利用 GeneratorAPI 暴露的 exitLog 方法在项目输出其他所有的 message 之后输出一些日志。</li>
</ul>
<p><strong>总结：</strong></p>
<p>vue create 命令总的来说就实例化了2个类，然后各自调了一个方法。当执行 create 命令时会创建一个 Creator 实例， 然后调用其 create 方法。在 create 方法中又会创建一个 Generator 实例，然后再调用其 generator 方法，初始化整个项目会交给各个插件去完成。比如核心插件 @vue/cli-service 会渲染整个项目的文件，@vue/cli-plugin-eslint 会进行 eslint 的一些配置， @vue/cli-plugin-unit-jest 插件也会进行一些 jest 的配置，各个功能都会交给对应的插件去完成，而 GeneratorAPI 又允许一个插件的 generator 向 package.json 注入额外的依赖或字段，并向项目中添加文件，这也让插件对整个项目拥有更高的可配置性。</p>
<h4 id="2-add-命令"><a class="markdownIt-Anchor" href="#2-add-命令"></a> 2、add 命令</h4>
<p>文章前面通过解析 vue create 命令的具体执行流程介绍了项目创建初始化的主要过程，其最核心的就是插件机制，其使得用户对项目有了更高的可配置性，再完成项目初始构建后我们依然可以通过 vue add 指令添加插件，那么其实现原理有是什么呢？</p>
<p>vue add 命令的入口在 packages/@vue/cli/bin/vue.js 中:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">program</span><br><span class="line">  .command(<span class="string">&#x27;add &lt;plugin&gt; [pluginOptions]&#x27;</span>)</span><br><span class="line">  .description(<span class="string">&#x27;install a plugin and invoke its generator in an already created project&#x27;</span>)</span><br><span class="line">  .option(<span class="string">&#x27;--registry &lt;url&gt;&#x27;</span>, <span class="string">&#x27;Use specified npm registry when installing dependencies (only for npm)&#x27;</span>)</span><br><span class="line">  .allowUnknownOption()</span><br><span class="line">  .action(<span class="function">(<span class="params">plugin</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">require</span>(<span class="string">&#x27;../lib/add&#x27;</span>)(plugin, minimist(process.argv.slice(<span class="number">3</span>)))</span><br><span class="line">  &#125;)</span><br></pre></td></tr></table></figure>
<p>从代码中可以看出，vue add 命令接受两个参数:</p>
<ul>
<li>plugin： 插件名称，必填。</li>
<li>registry： 安装插件指定的安装源，只针对于 npm 包管理器，选填。</li>
</ul>
<p>当执行了 vue add 命令后会加载 @vue/cli/lib/add.js，下面就逐步开始分析。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = <span class="function">(<span class="params">...args</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> add(...args).catch(<span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">    error(err)</span><br><span class="line">    <span class="keyword">if</span> (!process.env.VUE_CLI_TEST) &#123;</span><br><span class="line">      process.exit(<span class="number">1</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们接着来查看 add 方法：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">add</span> (<span class="params">pluginToAdd, options = &#123;&#125;, context = process.cwd()</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!(<span class="keyword">await</span> confirmIfGitDirty(context))) &#123;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// for `vue add` command in 3.x projects</span></span><br><span class="line">  <span class="keyword">const</span> servicePkg = loadModule(<span class="string">&#x27;@vue/cli-service/package.json&#x27;</span>, context)</span><br><span class="line">  <span class="keyword">if</span> (servicePkg &amp;&amp; semver.satisfies(servicePkg.version, <span class="string">&#x27;3.x&#x27;</span>)) &#123;</span><br><span class="line">    <span class="comment">// special internal &quot;plugins&quot;</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="regexp">/^(@vue\/)?router$/</span>.test(pluginToAdd)) &#123; <span class="comment">// 匹配 @vue/router，router</span></span><br><span class="line">      <span class="keyword">return</span> addRouter(context)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="regexp">/^(@vue\/)?vuex$/</span>.test(pluginToAdd)) &#123; <span class="comment">// 匹配 @vue/vuex，vuex</span></span><br><span class="line">      <span class="keyword">return</span> addVuex(context)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 解析插件名称</span></span><br><span class="line">  <span class="comment">// @bar/foo =&gt; @bar/vue-cli-plugin-foo</span></span><br><span class="line">  <span class="comment">// @vue/foo =&gt; @vue/cli-plugin-foo</span></span><br><span class="line">  <span class="comment">// foo =&gt; vue-cli-plugin-foo</span></span><br><span class="line">  <span class="keyword">const</span> pluginRe = <span class="regexp">/^(@?[^@]+)(?:@(.+))?$/</span></span><br><span class="line">  <span class="keyword">const</span> [</span><br><span class="line">    <span class="comment">// eslint-disable-next-line</span></span><br><span class="line">    _skip,</span><br><span class="line">    pluginName,</span><br><span class="line">    pluginVersion</span><br><span class="line">  ] = pluginToAdd.match(pluginRe)</span><br><span class="line">  <span class="keyword">const</span> packageName = resolvePluginId(pluginName)</span><br><span class="line"></span><br><span class="line">  log()</span><br><span class="line">  log(<span class="string">`📦  Installing <span class="subst">$&#123;chalk.cyan(packageName)&#125;</span>...`</span>)</span><br><span class="line">  log()</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> pm = <span class="keyword">new</span> PackageManager(&#123; context &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (pluginVersion) &#123;</span><br><span class="line">    <span class="keyword">await</span> pm.add(<span class="string">`<span class="subst">$&#123;packageName&#125;</span>@<span class="subst">$&#123;pluginVersion&#125;</span>`</span>)</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isOfficialPlugin(packageName)) &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; latestMinor &#125; = <span class="keyword">await</span> getVersions()</span><br><span class="line">    <span class="keyword">await</span> pm.add(<span class="string">`<span class="subst">$&#123;packageName&#125;</span>@~<span class="subst">$&#123;latestMinor&#125;</span>`</span>)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">await</span> pm.add(packageName, &#123; <span class="attr">tilde</span>: <span class="literal">true</span> &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  log(<span class="string">`<span class="subst">$&#123;chalk.green(<span class="string">&#x27;✔&#x27;</span>)&#125;</span>  Successfully installed plugin: <span class="subst">$&#123;chalk.cyan(packageName)&#125;</span>`</span>)</span><br><span class="line">  log()</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> generatorPath = resolveModule(<span class="string">`<span class="subst">$&#123;packageName&#125;</span>/generator`</span>, context)</span><br><span class="line">  <span class="keyword">if</span> (generatorPath) &#123;</span><br><span class="line">    invoke(pluginName, options, context)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    log(<span class="string">`Plugin <span class="subst">$&#123;packageName&#125;</span> does not have a generator to invoke`</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>add 函数的主要功能就是安装插件包，对于 vue-cli 内部一些特殊的&quot;插件&quot;，比如 router，vuex，就不会通过包管理器安装，而是直接加载 @vue/cli-service/generator/router 和 @vue/cli-service/generator/vuex，这两个文件也是两个 generator，可以向 package.json 注入额外的依赖或字段，并向项目中添加文件，对于普通的第三方插件，则需要通过包管理器安装，示例调用的 <code>pm.add</code> 方法实现如下所示：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// @vue/cli/lib/util/ProjectPackageManager.js</span></span><br><span class="line"><span class="keyword">async</span> add (packageName, &#123;</span><br><span class="line">  tilde = <span class="literal">false</span>,</span><br><span class="line">  dev = <span class="literal">true</span></span><br><span class="line">&#125; = &#123;&#125;) &#123;</span><br><span class="line">  <span class="keyword">const</span> args = dev ? [<span class="string">&#x27;-D&#x27;</span>] : []</span><br><span class="line">  <span class="keyword">if</span> (tilde) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.bin === <span class="string">&#x27;yarn&#x27;</span>) &#123;</span><br><span class="line">      args.push(<span class="string">&#x27;--tilde&#x27;</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      process.env.npm_config_save_prefix = <span class="string">&#x27;~&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">this</span>.needsPeerDepsFix) &#123;</span><br><span class="line">    args.push(<span class="string">&#x27;--legacy-peer-deps&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">await</span> <span class="built_in">this</span>.runCommand(<span class="string">&#x27;add&#x27;</span>, [packageName, ...args])</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果用户指定插件包名称时未指定版本号那么在调用 <code>pm.add</code> 方法时会传入参数 <code>tilde: true</code>，在 <code>pm.add</code> 的内部会根据包管理器的具体类型进行判断，如果是 yarn 会添加 --tilde 参数，如果是 npm 或 pnpm 则会将 npm_config_save_prefix 的配置设为 ‘~’，这个配置的默认值为 ‘^’, 例如一个包的版本是 1.2.3，默认情况下那么在 package.json 中就会被设置为 ‘^1.2.3’，这样，对于 minor 部分的更新依然是可以的。但是如果设置了 npm config set save-prefix=”~”，那么就会被设置为 ”~1.2.3”，此时只允许最后一位数字的版本更新。最后再通过 runCommand 函数执行具体包管理器（如 yarn）的 add 指令。</p>
<p>在 vue-cli 官方文档中对插件 的命名有着明确的要求，即命名方式为：<code>vue-cli-plugin-&lt;name&gt;</code>，插件遵循命名约定之后就可以：</p>
<ul>
<li>被 @vue/cli-service 发现；</li>
<li>被其它开发者搜索到；</li>
<li>通过 <code>vue add &lt;name&gt;</code> 或 <code>vue invoke &lt;name&gt;</code> 安装下来。</li>
</ul>
<p>在获取第三方插件名称后，就会调用 invoke 方法安装插件包：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">invoke</span> (<span class="params">pluginName, options = &#123;&#125;, context = process.cwd()</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!(<span class="keyword">await</span> confirmIfGitDirty(context))) &#123;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">delete</span> options._</span><br><span class="line">  <span class="keyword">const</span> pkg = getPkg(context) <span class="comment">// 解析 package.json</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// attempt to locate the plugin in package.json</span></span><br><span class="line">  <span class="keyword">const</span> findPlugin = <span class="function"><span class="params">deps</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!deps) <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">let</span> name</span><br><span class="line">    <span class="comment">// official</span></span><br><span class="line">    <span class="keyword">if</span> (deps[(name = <span class="string">`@vue/cli-plugin-<span class="subst">$&#123;pluginName&#125;</span>`</span>)]) &#123;</span><br><span class="line">      <span class="keyword">return</span> name</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// full id, scoped short, or default short</span></span><br><span class="line">    <span class="keyword">if</span> (deps[(name = resolvePluginId(pluginName))]) &#123;</span><br><span class="line">      <span class="keyword">return</span> name</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> id = findPlugin(pkg.devDependencies) || findPlugin(pkg.dependencies)</span><br><span class="line">  <span class="keyword">if</span> (!id) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(</span><br><span class="line">      <span class="string">`Cannot resolve plugin <span class="subst">$&#123;chalk.yellow(pluginName)&#125;</span> from package.json. `</span> +</span><br><span class="line">        <span class="string">`Did you forget to install it?`</span></span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> pluginGenerator = loadModule(<span class="string">`<span class="subst">$&#123;id&#125;</span>/generator`</span>, context)</span><br><span class="line">  <span class="keyword">if</span> (!pluginGenerator) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">`Plugin <span class="subst">$&#123;id&#125;</span> does not have a generator.`</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// resolve options if no command line options (other than --registry) are passed,</span></span><br><span class="line">  <span class="comment">// and the plugin contains a prompt module.</span></span><br><span class="line">  <span class="comment">// eslint-disable-next-line prefer-const</span></span><br><span class="line">  <span class="keyword">let</span> &#123; registry, $inlineOptions, ...pluginOptions &#125; = options</span><br><span class="line">  <span class="keyword">if</span> ($inlineOptions) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      pluginOptions = <span class="built_in">JSON</span>.parse($inlineOptions)</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">`Couldn&#x27;t parse inline options JSON: <span class="subst">$&#123;e.message&#125;</span>`</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="built_in">Object</span>.keys(pluginOptions).length) &#123;</span><br><span class="line">    <span class="keyword">let</span> pluginPrompts = loadModule(<span class="string">`<span class="subst">$&#123;id&#125;</span>/prompts`</span>, context)</span><br><span class="line">    <span class="keyword">if</span> (pluginPrompts) &#123;</span><br><span class="line">      <span class="keyword">const</span> prompt = inquirer.createPromptModule()</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">typeof</span> pluginPrompts === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">        pluginPrompts = pluginPrompts(pkg, prompt)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">typeof</span> pluginPrompts.getPrompts === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">        pluginPrompts = pluginPrompts.getPrompts(pkg, prompt)</span><br><span class="line">      &#125;</span><br><span class="line">      pluginOptions = <span class="keyword">await</span> prompt(pluginPrompts)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> plugin = &#123;</span><br><span class="line">    id,</span><br><span class="line">    apply: pluginGenerator,</span><br><span class="line">    options: &#123;</span><br><span class="line">      registry,</span><br><span class="line">      ...pluginOptions</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">await</span> runGenerator(context, plugin, pkg)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>该方法先调用 findPlugin 判断插件是否安装，如果安装也返回插件名，接着获取目标插件下的 generator 方法。然后就是判断命令行是否传入行内参数，如果没有并且传入插件参数为空则调用 inquirer.prompt 获取插件的 option，并传给其 generator，在完成这些以后，就是 runGenerator。这儿的 runGenerator 的具体实现与 vue create 命令中项目生成的阶段基本一致，实质上就是构造一个 Generator 实例，并调用其 generate 方法。在实例的 generator 方法调用完成之后执行以下命令：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git ls-files --exclude-standard --modified --others</span><br></pre></td></tr></table></figure>
<p>因为插件的 generator 可以通过 GeneratorAPI 暴露的 render 和 extendPackage 方法修改项目的文件，因此通过执行该命令将变化的文件显示在终端上，这对开发者十分地友好。</p>
<p>vue add 相当于只是 vue create 中的一部分，vue create 包含了插件的安装以及调用，vue add 命令只是将此功能分离了出来，而 vue invoke 命令其实是 vue add 命名去掉了插件包安装的那一部分，其他 vue 命令由于篇幅限制（wo tai lan le）此处不再介绍。</p>
<h3 id="三-vuecli-service"><a class="markdownIt-Anchor" href="#三-vuecli-service"></a> 三、@vue/cli-service</h3>
<p>在 Vue CLI 中将 webpack 及相关插件提供的功能都收敛到 @vue/cli-service 内部来实现，提供了 vue-cli-service 命令帮助使用者最基本的日常开发，下面就开始分析 @vue/cli-service 的具体实现。</p>
<h4 id="1-入口"><a class="markdownIt-Anchor" href="#1-入口"></a> 1、入口</h4>
<p>vue-cli-service m命令的入口在 @vue/cli-service/bin/vue-service-service.js 中，代码如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// @vue/cli-service/bin/vue-service-service.js</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#!/usr/bin/env node</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> &#123; semver, error &#125; = <span class="built_in">require</span>(<span class="string">&#x27;@vue/cli-shared-utils&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> requiredVersion = <span class="built_in">require</span>(<span class="string">&#x27;../package.json&#x27;</span>).engines.node</span><br><span class="line"></span><br><span class="line"><span class="comment">// Node 版本校验</span></span><br><span class="line"><span class="keyword">if</span> (!semver.satisfies(process.version, requiredVersion, &#123; <span class="attr">includePrerelease</span>: <span class="literal">true</span> &#125;)) &#123;</span><br><span class="line">  error(</span><br><span class="line">    <span class="string">`You are using Node <span class="subst">$&#123;process.version&#125;</span>, but vue-cli-service `</span> +</span><br><span class="line">    <span class="string">`requires Node <span class="subst">$&#123;requiredVersion&#125;</span>.\nPlease upgrade your Node version.`</span></span><br><span class="line">  )</span><br><span class="line">  process.exit(<span class="number">1</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> Service = <span class="built_in">require</span>(<span class="string">&#x27;../lib/Service&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> service = <span class="keyword">new</span> Service(process.env.VUE_CLI_CONTEXT || process.cwd())</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取命令参数 vue-cli-service serve --https</span></span><br><span class="line"><span class="keyword">const</span> rawArgv = process.argv.slice(<span class="number">2</span>)</span><br><span class="line"><span class="comment">// 在 boolean 选项当中的参数会被解析成 true，例如 args.https: true, args.modern: false</span></span><br><span class="line"><span class="keyword">const</span> args = <span class="built_in">require</span>(<span class="string">&#x27;minimist&#x27;</span>)(rawArgv, &#123;</span><br><span class="line">  boolean: [</span><br><span class="line">    <span class="comment">// build</span></span><br><span class="line">    <span class="comment">// <span class="doctag">FIXME:</span> --no-module, --no-unsafe-inline, no-clean, etc.</span></span><br><span class="line">    <span class="string">&#x27;modern&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;report&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;report-json&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;inline-vue&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;watch&#x27;</span>,</span><br><span class="line">    <span class="comment">// serve</span></span><br><span class="line">    <span class="string">&#x27;open&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;copy&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;https&#x27;</span>,</span><br><span class="line">    <span class="comment">// inspect</span></span><br><span class="line">    <span class="string">&#x27;verbose&#x27;</span></span><br><span class="line">  ]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">const</span> command = args._[<span class="number">0</span>] <span class="comment">// serve</span></span><br><span class="line"></span><br><span class="line">service.run(command, args, rawArgv).catch(<span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">  error(err)</span><br><span class="line">  process.exit(<span class="number">1</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>代码看着非常简洁，与一般 node 命令文件有点不同，第一就是并没有依赖 commander.js，第二就是并没有直接提供相关 CLI 命令的服务。 在 @vue/vue-cli-service 中，对于第一点是通过 Service 这个类来处理 node 命令，而对于第二点，所有的 CLI 服务都是动态注册的。从上面这段代码可以看出，执行 CLI 命令后，主要有两个操作：实例化 Service 和调用实例的 run 方法。</p>
<h4 id="2-service-类实例化"><a class="markdownIt-Anchor" href="#2-service-类实例化"></a> 2、Service 类实例化</h4>
<p>我们接着查看 Service 类的构造函数：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// @vue/cli-service/lib/Service.js</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="class"><span class="keyword">class</span> <span class="title">Service</span> </span>&#123;</span><br><span class="line">  <span class="title">constructor</span> (<span class="params">context, &#123; plugins, pkg, inlineOptions, useBuiltIn &#125; = &#123;&#125;</span>) &#123;</span><br><span class="line">    checkWebpack(context)</span><br><span class="line"></span><br><span class="line">    process.VUE_CLI_SERVICE = <span class="built_in">this</span></span><br><span class="line">    <span class="built_in">this</span>.initialized = <span class="literal">false</span></span><br><span class="line">    <span class="built_in">this</span>.context = context</span><br><span class="line">    <span class="built_in">this</span>.inlineOptions = inlineOptions</span><br><span class="line">    <span class="built_in">this</span>.webpackChainFns = []</span><br><span class="line">    <span class="built_in">this</span>.webpackRawConfigFns = []</span><br><span class="line">    <span class="built_in">this</span>.devServerConfigFns = []</span><br><span class="line">    <span class="built_in">this</span>.commands = &#123;&#125;</span><br><span class="line">    <span class="comment">// Folder containing the target package.json for plugins</span></span><br><span class="line">    <span class="built_in">this</span>.pkgContext = context</span><br><span class="line">    <span class="comment">// package.json containing the plugins</span></span><br><span class="line">    <span class="built_in">this</span>.pkg = <span class="built_in">this</span>.resolvePkg(pkg)</span><br><span class="line">    <span class="comment">// If there are inline plugins, they will be used instead of those</span></span><br><span class="line">    <span class="comment">// found in package.json.</span></span><br><span class="line">    <span class="comment">// When useBuiltIn === false, built-in plugins are disabled. This is mostly</span></span><br><span class="line">    <span class="comment">// for testing.</span></span><br><span class="line">    <span class="comment">// 如果有 inline plugins 的话，就不会去加载 package.json 里 devDependencies 和 dependencies 的插件，useBuiltIn 为 false 时 builtInPlugins 会被禁用</span></span><br><span class="line">    <span class="built_in">this</span>.plugins = <span class="built_in">this</span>.resolvePlugins(plugins, useBuiltIn)</span><br><span class="line">    <span class="comment">// pluginsToSkip will be populated during run()</span></span><br><span class="line">    <span class="built_in">this</span>.pluginsToSkip = <span class="keyword">new</span> <span class="built_in">Set</span>()</span><br><span class="line">    <span class="comment">// resolve the default mode to use for each command</span></span><br><span class="line">    <span class="comment">// this is provided by plugins as module.exports.defaultModes</span></span><br><span class="line">    <span class="comment">// so we can get the information without actually applying the plugin.</span></span><br><span class="line">    <span class="comment">// 注册的插件可以通过 module.exports.defaultModes 指定特定的模式</span></span><br><span class="line">    <span class="comment">/*&#123;</span></span><br><span class="line"><span class="comment">      serve: &#x27;development&#x27;,</span></span><br><span class="line"><span class="comment">      build: &#x27;production&#x27;,</span></span><br><span class="line"><span class="comment">      inspect: &#x27;development&#x27;,</span></span><br><span class="line"><span class="comment">      &#x27;test:unit&#x27;: &#x27;test&#x27;</span></span><br><span class="line"><span class="comment">    &#125;*/</span></span><br><span class="line">    <span class="built_in">this</span>.modes = <span class="built_in">this</span>.plugins.reduce(<span class="function">(<span class="params">modes, &#123; apply: &#123; defaultModes &#125; &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">Object</span>.assign(modes, defaultModes)</span><br><span class="line">    &#125;, &#123;&#125;)</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>实例化的过程主要进行了插件的解析和为每一种 CLI 命令指定模式，先看一下插件的解析：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// @vue/cli-service/lib/Service.js</span></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="class"><span class="keyword">class</span> <span class="title">Service</span> </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  resolvePlugins (inlinePlugins, useBuiltIn) &#123;</span><br><span class="line">    <span class="keyword">const</span> idToPlugin = <span class="function">(<span class="params">id, absolutePath</span>) =&gt;</span> (&#123;</span><br><span class="line">      id: id.replace(<span class="regexp">/^.\//</span>, <span class="string">&#x27;built-in:&#x27;</span>),</span><br><span class="line">      apply: <span class="built_in">require</span>(absolutePath || id)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> plugins</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 内置插件</span></span><br><span class="line">    <span class="keyword">const</span> builtInPlugins = [</span><br><span class="line">      <span class="string">&#x27;./commands/serve&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;./commands/build&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;./commands/inspect&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;./commands/help&#x27;</span>,</span><br><span class="line">      <span class="comment">// config plugins are order sensitive</span></span><br><span class="line">      <span class="string">&#x27;./config/base&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;./config/assets&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;./config/css&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;./config/prod&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;./config/app&#x27;</span></span><br><span class="line">    ].map(<span class="function">(<span class="params">id</span>) =&gt;</span> idToPlugin(id)) <span class="comment">// [&#123; id: &#x27;built-in:commands/serve&#x27;, apply:&#123; [Function] defaultModes: [Object] &#125; &#125;,...]</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 实例化 Service 时传入插件</span></span><br><span class="line">    <span class="keyword">if</span> (inlinePlugins) &#123;</span><br><span class="line">      plugins = useBuiltIn !== <span class="literal">false</span></span><br><span class="line">        ? builtInPlugins.concat(inlinePlugins)</span><br><span class="line">        : inlinePlugins</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> projectPlugins = <span class="built_in">Object</span>.keys(<span class="built_in">this</span>.pkg.devDependencies || &#123;&#125;)</span><br><span class="line">        .concat(<span class="built_in">Object</span>.keys(<span class="built_in">this</span>.pkg.dependencies || &#123;&#125;))</span><br><span class="line">        .filter(isPlugin) <span class="comment">// isPlugin = id =&gt; /^(@vue\/|vue-|@[\w-]+\/vue-)cli-plugin-/.test(id)</span></span><br><span class="line">        .map(<span class="function"><span class="params">id</span> =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">if</span> (</span><br><span class="line">            <span class="built_in">this</span>.pkg.optionalDependencies &amp;&amp;</span><br><span class="line">            id <span class="keyword">in</span> <span class="built_in">this</span>.pkg.optionalDependencies</span><br><span class="line">          ) &#123;</span><br><span class="line">            <span class="keyword">let</span> apply = loadModule(id, <span class="built_in">this</span>.pkgContext)</span><br><span class="line">            <span class="keyword">if</span> (!apply) &#123;</span><br><span class="line">              warn(<span class="string">`Optional dependency <span class="subst">$&#123;id&#125;</span> is not installed.`</span>)</span><br><span class="line">              apply = <span class="function">() =&gt;</span> &#123;&#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> &#123; id, apply &#125;</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> idToPlugin(id, resolveModule(id, <span class="built_in">this</span>.pkgContext))</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;)</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Add the plugin automatically to simplify the webpack-4 tests</span></span><br><span class="line">      <span class="comment">// so that a simple Jest alias would suffice, avoid changing every</span></span><br><span class="line">      <span class="comment">// preset used in the tests</span></span><br><span class="line">      <span class="keyword">if</span> (</span><br><span class="line">        process.env.VUE_CLI_TEST &amp;&amp;</span><br><span class="line">        process.env.VUE_CLI_USE_WEBPACK4 &amp;&amp;</span><br><span class="line">        !projectPlugins.some(<span class="function">(<span class="params">p</span>) =&gt;</span> p.id === <span class="string">&#x27;@vue/cli-plugin-webpack-4&#x27;</span>)</span><br><span class="line">      ) &#123;</span><br><span class="line">        builtInPlugins.push(idToPlugin(<span class="string">&#x27;@vue/cli-plugin-webpack-4&#x27;</span>))</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      plugins = builtInPlugins.concat(projectPlugins)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Local plugins</span></span><br><span class="line">    <span class="comment">// 项目本地的插件，针对于只需要在项目里直接访问插件 API 而不需要创建一个完整的插件</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.pkg.vuePlugins &amp;&amp; <span class="built_in">this</span>.pkg.vuePlugins.service) &#123;</span><br><span class="line">      <span class="keyword">const</span> files = <span class="built_in">this</span>.pkg.vuePlugins.service</span><br><span class="line">      <span class="keyword">if</span> (!<span class="built_in">Array</span>.isArray(files)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">`Invalid type for option &#x27;vuePlugins.service&#x27;, expected &#x27;array&#x27; but got <span class="subst">$&#123;<span class="keyword">typeof</span> files&#125;</span>.`</span>)</span><br><span class="line">      &#125;</span><br><span class="line">      plugins = plugins.concat(files.map(<span class="function"><span class="params">file</span> =&gt;</span> (&#123;</span><br><span class="line">        id: <span class="string">`local:<span class="subst">$&#123;file&#125;</span>`</span>,</span><br><span class="line">        apply: loadModule(<span class="string">`./<span class="subst">$&#123;file&#125;</span>`</span>, <span class="built_in">this</span>.pkgContext)</span><br><span class="line">      &#125;)))</span><br><span class="line">    &#125;</span><br><span class="line">    debug(<span class="string">&#x27;vue:plugins&#x27;</span>)(plugins)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> orderedPlugins = sortPlugins(plugins)</span><br><span class="line">    debug(<span class="string">&#x27;vue:plugins-ordered&#x27;</span>)(orderedPlugins)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> orderedPlugins</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以将解析的插件分为4类：</p>
<ul>
<li>内置插件</li>
<li>inlinePlugins</li>
<li>package.json 插件</li>
<li>package.vuePlugins 插件</li>
</ul>
<p><strong>内置插件</strong>指的是 @vue/cli-service 内部提供的插件，又可以大致分为两类，serve、build、inspect、help 这一类插件在内部动态注册新的 CLI 命令， 开发者即可通过 npm script 的形式去启动对应的 CLI 命令服务，base ,css, dev, prod, app 这一类插件主要是完成 webpack 本地编译构建时的各种相关的配置。 @vue/cli-service 将 webpack 的开发构建功能收敛到内部来完成。</p>
<p><strong>inlinePlugins</strong> 指的是直接在实例化 Service 时传入，执行 vue serve 和 vue build 命令时会创建一个 Service 实例，并传入 inlinePlugins。</p>
<p><strong>package.json 插件</strong>指的是 devDependencies 和 dependencies 中的 vue 插件，比如 @vue/cli-plugin-eslint。</p>
<p><strong>package.vuePlugins</strong> 也是在 package.json 中的插件，不过是在 vuePlugins 字段中，该类插件是针对于只需要在项目里直接访问插件 API 而不需要创建一个完整的插件。</p>
<p>我们接着查看 CLI 指定模式：</p>
<p>CLI 模式是 vue cli 中一个重要的概念，默认情况下，一个 Vue CLI 项目有三个模式：</p>
<ul>
<li>development 模式用于 vue-cli-service serve</li>
<li>test 模式用于 vue-cli-service test:unit</li>
<li>production 模式用于 vue-cli-service build 和 vue-cli-service test:e2e</li>
</ul>
<p>我们也可以通过传递 --mode 选项参数为命令行覆写默认的模式。详情可查看<a target="_blank" rel="noopener" href="https://cli.vuejs.org/zh/guide/mode-and-env.html#%E6%A8%A1%E5%BC%8F">官方文档</a>。</p>
<p>在 Service 的构造函数中解析完插件之后就为每种插件命令指定模式，插件命令的模式可以 通过 module.exports.defaultModes 以 { [commandName]: mode } 的形式来暴露：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="params">api</span> =&gt;</span> &#123;</span><br><span class="line">  api.registerCommand(<span class="string">&#x27;build&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports.defaultModes = &#123;</span><br><span class="line">  build: <span class="string">&#x27;production&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>解析命令模式利用 js 内建函数 reduce 实现:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">this</span>.modes = <span class="built_in">this</span>.plugins.reduce(<span class="function">(<span class="params">modes, &#123; apply: &#123; defaultModes &#125;&#125;</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">Object</span>.assign(modes, defaultModes)</span><br><span class="line">&#125;, &#123;&#125;)</span><br></pre></td></tr></table></figure>
<h4 id="3-实例的-run-方法"><a class="markdownIt-Anchor" href="#3-实例的-run-方法"></a> 3、实例的 run 方法</h4>
<p>在 vue-cli-service 的入口处完成 Service 类的实例化后又调用了实例的 run 方法，我们接着查看其具体实现：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// @vue/cli-service/lib/Service.js</span></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="class"><span class="keyword">class</span> <span class="title">Service</span> </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">async</span> run (name, args = &#123;&#125;, rawArgv = []) &#123;</span><br><span class="line">    <span class="comment">// resolve mode</span></span><br><span class="line">    <span class="comment">// prioritize inline --mode</span></span><br><span class="line">    <span class="comment">// fallback to resolved default modes from plugins or development if --watch is defined</span></span><br><span class="line">    <span class="keyword">const</span> mode = args.mode || (name === <span class="string">&#x27;build&#x27;</span> &amp;&amp; args.watch ? <span class="string">&#x27;development&#x27;</span> : <span class="built_in">this</span>.modes[name])</span><br><span class="line"></span><br><span class="line">    <span class="comment">// --skip-plugins arg may have plugins that should be skipped during init()</span></span><br><span class="line">    <span class="built_in">this</span>.setPluginsToSkip(args)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// load env variables, load user config, apply plugins</span></span><br><span class="line">    <span class="keyword">await</span> <span class="built_in">this</span>.init(mode)</span><br><span class="line"></span><br><span class="line">    args._ = args._ || []</span><br><span class="line">    <span class="keyword">let</span> command = <span class="built_in">this</span>.commands[name] <span class="comment">// 这里的 commands 就是加载插件时通过 api.registerCommand 注册的 command，后续详细介绍</span></span><br><span class="line">    <span class="keyword">if</span> (!command &amp;&amp; name) &#123;</span><br><span class="line">      error(<span class="string">`command &quot;<span class="subst">$&#123;name&#125;</span>&quot; does not exist.`</span>)</span><br><span class="line">      process.exit(<span class="number">1</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!command || args.help || args.h) &#123;</span><br><span class="line">      command = <span class="built_in">this</span>.commands.help</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      args._.shift() <span class="comment">// remove command itself</span></span><br><span class="line">      rawArgv.shift()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> &#123; fn &#125; = command</span><br><span class="line">    <span class="keyword">return</span> fn(args, rawArgv)</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>run 方法开始会获取该命令所对应的模式值，然后调用实例的 init 方法，init 主要有三个功能：</p>
<ul>
<li>加载对应模式下本地的环境变量文件</li>
<li>解析 vue.config.js 或者 package.vue</li>
<li>执行所有被加载的插件</li>
</ul>
<p>我们来查看 init 方法的具体实现：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = <span class="class"><span class="keyword">class</span> <span class="title">Service</span> </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  init (mode = process.env.VUE_CLI_MODE) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.initialized) &#123;</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">this</span>.initialized = <span class="literal">true</span></span><br><span class="line">    <span class="built_in">this</span>.mode = mode</span><br><span class="line"></span><br><span class="line">    <span class="comment">// load mode .env</span></span><br><span class="line">    <span class="comment">// 加载指定的模式环境文件</span></span><br><span class="line">    <span class="keyword">if</span> (mode) &#123;</span><br><span class="line">      <span class="built_in">this</span>.loadEnv(mode)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// load base .env</span></span><br><span class="line">    <span class="comment">// 加载普通环境文件</span></span><br><span class="line">    <span class="built_in">this</span>.loadEnv()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// load user config</span></span><br><span class="line">    <span class="keyword">const</span> userOptions = <span class="built_in">this</span>.loadUserOptions()</span><br><span class="line">    <span class="keyword">const</span> loadedCallback = <span class="function">(<span class="params">loadedUserOptions</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">this</span>.projectOptions = defaultsDeep(loadedUserOptions, defaults())</span><br><span class="line"></span><br><span class="line">      debug(<span class="string">&#x27;vue:project-config&#x27;</span>)(<span class="built_in">this</span>.projectOptions)</span><br><span class="line"></span><br><span class="line">      <span class="comment">// apply plugins.</span></span><br><span class="line">      <span class="built_in">this</span>.plugins.forEach(<span class="function">(<span class="params">&#123; id, apply &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.pluginsToSkip.has(id)) <span class="keyword">return</span></span><br><span class="line">        apply(<span class="keyword">new</span> PluginAPI(id, <span class="built_in">this</span>), <span class="built_in">this</span>.projectOptions)</span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">      <span class="comment">// apply webpack configs from project config file</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">this</span>.projectOptions.chainWebpack) &#123;</span><br><span class="line">        <span class="built_in">this</span>.webpackChainFns.push(<span class="built_in">this</span>.projectOptions.chainWebpack)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">this</span>.projectOptions.configureWebpack) &#123;</span><br><span class="line">        <span class="built_in">this</span>.webpackRawConfigFns.push(<span class="built_in">this</span>.projectOptions.configureWebpack)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (isPromise(userOptions)) &#123;</span><br><span class="line">      <span class="keyword">return</span> userOptions.then(loadedCallback)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> loadedCallback(userOptions)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>init 执行了两次实例的 loadEnv 函数，第一次是加载指定的模式环境文件（.env.development, .env.development.local），第二次执行是加载普通环境文件 (.env, .env.local)，看一下实例 loadEnv 函数代码：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 加载本地的环境文件，环境文件的作用就是设置某个模式下特有的环境变量</span></span><br><span class="line"><span class="comment">// 加载环境变量其实要注意的就是优先级的问题，下面的代码已经体现的非常明显了，先加载 .env.mode.local，然后加载 .env.mode 最后再加载 .env</span></span><br><span class="line"><span class="comment">// 由于环境变量不会被覆盖，因此 .env.mode.local 的优先级最高，.env.mode.local 与 .env.mode 的区别就是前者会被 git 忽略掉。另外一点要</span></span><br><span class="line"><span class="comment">// 注意的就是环境文件不会覆盖Vue CLI 启动时已经存在的环境变量。</span></span><br><span class="line">loadEnv (mode) &#123;</span><br><span class="line">  <span class="keyword">const</span> logger = debug(<span class="string">&#x27;vue:env&#x27;</span>)</span><br><span class="line">  <span class="comment">// path/.env.production || path/.env.development || ...</span></span><br><span class="line">  <span class="keyword">const</span> basePath = path.resolve(<span class="built_in">this</span>.context, <span class="string">`.env<span class="subst">$&#123;mode ? <span class="string">`.<span class="subst">$&#123;mode&#125;</span>`</span> : <span class="string">``</span>&#125;</span>`</span>)</span><br><span class="line">  <span class="keyword">const</span> localPath = <span class="string">`<span class="subst">$&#123;basePath&#125;</span>.local`</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> load = <span class="function"><span class="params">envPath</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> env = dotenv.config(&#123; <span class="attr">path</span>: envPath, <span class="attr">debug</span>: process.env.DEBUG &#125;) <span class="comment">// 加载指定路径的环境变量</span></span><br><span class="line">      dotenvExpand(env)</span><br><span class="line">      logger(envPath, env)</span><br><span class="line">    &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">      <span class="comment">// only ignore error if file is not found</span></span><br><span class="line">      <span class="keyword">if</span> (err.toString().indexOf(<span class="string">&#x27;ENOENT&#x27;</span>) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        error(err)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  load(localPath)</span><br><span class="line">  load(basePath)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// by default, NODE_ENV and BABEL_ENV are set to &quot;development&quot; unless mode</span></span><br><span class="line">  <span class="comment">// is production or test. However the value in .env files will take higher</span></span><br><span class="line">  <span class="comment">// priority.</span></span><br><span class="line">  <span class="keyword">if</span> (mode) &#123;</span><br><span class="line">    <span class="comment">// always set NODE_ENV during tests</span></span><br><span class="line">    <span class="comment">// as that is necessary for tests to not be affected by each other</span></span><br><span class="line">    <span class="keyword">const</span> shouldForceDefaultEnv = (</span><br><span class="line">      process.env.VUE_CLI_TEST &amp;&amp;</span><br><span class="line">      !process.env.VUE_CLI_TEST_TESTING_ENV</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">const</span> defaultNodeEnv = (mode === <span class="string">&#x27;production&#x27;</span> || mode === <span class="string">&#x27;test&#x27;</span>)</span><br><span class="line">      ? mode</span><br><span class="line">      : <span class="string">&#x27;development&#x27;</span></span><br><span class="line">    <span class="keyword">if</span> (shouldForceDefaultEnv || process.env.NODE_ENV == <span class="literal">null</span>) &#123;</span><br><span class="line">      process.env.NODE_ENV = defaultNodeEnv</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (shouldForceDefaultEnv || process.env.BABEL_ENV == <span class="literal">null</span>) &#123;</span><br><span class="line">      process.env.BABEL_ENV = defaultNodeEnv</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过代码我们可以看到 loadEnv 方法的主要作用就是向 node process 中添加环境变量。我们接着查看 loadUserOptions：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Note: we intentionally make this function synchronous by default</span></span><br><span class="line"><span class="comment">// because eslint-import-resolver-webpack does not support async webpack configs.</span></span><br><span class="line">loadUserOptions () &#123;</span><br><span class="line">  <span class="comment">// fileConfig: import(fileConfigPath)/require(fileConfigPath), fileConfigPath: path.resolve(context, &#x27;./vue.config.js&#x27;)</span></span><br><span class="line">  <span class="keyword">const</span> &#123; fileConfig, fileConfigPath &#125; = loadFileConfig(<span class="built_in">this</span>.context)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (isPromise(fileConfig)) &#123;</span><br><span class="line">    <span class="keyword">return</span> fileConfig</span><br><span class="line">      .then(<span class="function"><span class="params">mod</span> =&gt;</span> mod.default)</span><br><span class="line">      .then(<span class="function"><span class="params">loadedConfig</span> =&gt;</span> resolveUserConfig(&#123;</span><br><span class="line">        inlineOptions: <span class="built_in">this</span>.inlineOptions,</span><br><span class="line">        pkgConfig: <span class="built_in">this</span>.pkg.vue,</span><br><span class="line">        fileConfig: loadedConfig,</span><br><span class="line">        fileConfigPath</span><br><span class="line">      &#125;))</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> resolveUserConfig(&#123;</span><br><span class="line">    inlineOptions: <span class="built_in">this</span>.inlineOptions,</span><br><span class="line">    pkgConfig: <span class="built_in">this</span>.pkg.vue, <span class="comment">// package.json 里面的 vue config</span></span><br><span class="line">    fileConfig,</span><br><span class="line">    fileConfigPath</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>示例代码中的 loadFileConfig 方法的主要作用是配置文件路径的获取及内容解析，其首先会在遍历 ‘./vue.config.js’、’./vue.config.cjs’、’./vue.config.mjs’ 查看当前项目目录下是否存在对应文件，如果存在则判断文件内容是否遵从 ESModule 规范？如果遵从则通过 import 方法获取文件内容，如果不是则通过 require 方法获取。在获取到配置文件内容后紧接着调用了 resolveUserConfig 函数，我们接着查看其实现：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span> <span class="title">resolveUserConfig</span> (<span class="params">&#123;</span></span></span><br><span class="line"><span class="function"><span class="params">  inlineOptions,</span></span></span><br><span class="line"><span class="function"><span class="params">  pkgConfig,</span></span></span><br><span class="line"><span class="function"><span class="params">  fileConfig,</span></span></span><br><span class="line"><span class="function"><span class="params">  fileConfigPath</span></span></span><br><span class="line"><span class="function"><span class="params">&#125;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (fileConfig) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> fileConfig === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">      fileConfig = fileConfig()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!fileConfig || <span class="keyword">typeof</span> fileConfig !== <span class="string">&#x27;object&#x27;</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(</span><br><span class="line">        <span class="string">`Error loading <span class="subst">$&#123;chalk.bold(fileConfigPath)&#125;</span>: `</span> +</span><br><span class="line">        <span class="string">`should export an object or a function that returns object.`</span></span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// package.vue</span></span><br><span class="line">  <span class="keyword">if</span> (pkgConfig &amp;&amp; <span class="keyword">typeof</span> pkgConfig !== <span class="string">&#x27;object&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(</span><br><span class="line">      <span class="string">`Error loading Vue CLI config in <span class="subst">$&#123;chalk.bold(<span class="string">`package.json`</span>)&#125;</span>: `</span> +</span><br><span class="line">      <span class="string">`the &quot;vue&quot; field should be an object.`</span></span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> resolved, resolvedFrom</span><br><span class="line">  <span class="comment">// 既有 vue.config.js 而且在 package.json 里面又包含了 vue 的配置，将会取 vue.config.js 的配置</span></span><br><span class="line">  <span class="keyword">if</span> (fileConfig) &#123;</span><br><span class="line">    <span class="keyword">const</span> configFileName = path.basename(fileConfigPath)</span><br><span class="line">    <span class="keyword">if</span> (pkgConfig) &#123;</span><br><span class="line">      warn(</span><br><span class="line">        <span class="string">`&quot;vue&quot; field in package.json ignored `</span> +</span><br><span class="line">        <span class="string">`due to presence of <span class="subst">$&#123;chalk.bold(configFileName)&#125;</span>.`</span></span><br><span class="line">      )</span><br><span class="line">      warn(</span><br><span class="line">        <span class="string">`You should migrate it into <span class="subst">$&#123;chalk.bold(configFileName)&#125;</span> `</span> +</span><br><span class="line">        <span class="string">`and remove it from package.json.`</span></span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line">    resolved = fileConfig</span><br><span class="line">    resolvedFrom = configFileName</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (pkgConfig) &#123;</span><br><span class="line">    resolved = pkgConfig</span><br><span class="line">    resolvedFrom = <span class="string">&#x27;&quot;vue&quot; field in package.json&#x27;</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    resolved = inlineOptions || &#123;&#125;</span><br><span class="line">    resolvedFrom = <span class="string">&#x27;inline options&#x27;</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// normalize some options</span></span><br><span class="line">  <span class="keyword">if</span> (resolved.publicPath !== <span class="string">&#x27;auto&#x27;</span>) &#123;</span><br><span class="line">    ensureSlash(resolved, <span class="string">&#x27;publicPath&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> resolved.publicPath === <span class="string">&#x27;string&#x27;</span>) &#123;</span><br><span class="line">    resolved.publicPath = resolved.publicPath.replace(<span class="regexp">/^\.\//</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  removeSlash(resolved, <span class="string">&#x27;outputDir&#x27;</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// validate options</span></span><br><span class="line">  validate(resolved, <span class="function"><span class="params">msg</span> =&gt;</span> &#123;</span><br><span class="line">    error(<span class="string">`Invalid options in <span class="subst">$&#123;chalk.bold(resolvedFrom)&#125;</span>: <span class="subst">$&#123;msg&#125;</span>`</span>)</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> resolved</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>示例代码首先会加载项目中 vue.config.js，然后会加载 package.json 中的 vue 字段中的配置信息。如果既有 vue.config.js 而且在 package.json 里面又包含了 vue 的配置，将会取 vue.config.js 的配置，如果两者都没有配置信息的话会取 this.inlineOptions || {}， 在获取到配置以后还会进行一些处理和验证，最后返回配置 resolved 。</p>
<p>在通过 loadUserOptions 方法完成了配置文件的解析及获取后紧接着便开始加载插件，核心代码如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// apply plugins.</span></span><br><span class="line"><span class="built_in">this</span>.plugins.forEach(<span class="function">(<span class="params">&#123; id, apply &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">this</span>.pluginsToSkip.has(id)) <span class="keyword">return</span></span><br><span class="line">  <span class="comment">// service 插件接受两个参数，一个 PluginAPI 实例，一个包含 vue.config.js 内指定的项目本地选项的对象，或者在 package.json 内的 vue 字段。</span></span><br><span class="line">  apply(<span class="keyword">new</span> PluginAPI(id, <span class="built_in">this</span>), <span class="built_in">this</span>.projectOptions)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>PluginAPI 类的核心代码如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Note: if a plugin-registered command needs to run in a specific default mode,</span></span><br><span class="line"><span class="comment">// the plugin needs to expose it via `module.exports.defaultModes` in the form</span></span><br><span class="line"><span class="comment">// of &#123; [commandName]: mode &#125;. This is because the command mode needs to be</span></span><br><span class="line"><span class="comment">// known and applied before loading user options / applying plugins.</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PluginAPI</span> </span>&#123;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param <span class="type">&#123;string&#125;</span> <span class="variable">id</span></span> - Id of the plugin.</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param <span class="type">&#123;Service&#125;</span> <span class="variable">service</span></span> - A vue-cli-service instance.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="title">constructor</span> (<span class="params">id, service</span>) &#123;</span><br><span class="line">    <span class="built_in">this</span>.id = id</span><br><span class="line">    <span class="built_in">this</span>.service = service</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  get version () &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">require</span>(<span class="string">&#x27;../package.json&#x27;</span>).version</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  assertVersion (range) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> range === <span class="string">&#x27;number&#x27;</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!<span class="built_in">Number</span>.isInteger(range)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&#x27;Expected string or integer value.&#x27;</span>)</span><br><span class="line">      &#125;</span><br><span class="line">      range = <span class="string">`^<span class="subst">$&#123;range&#125;</span>.0.0-0`</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> range !== <span class="string">&#x27;string&#x27;</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&#x27;Expected string or integer value.&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (semver.satisfies(<span class="built_in">this</span>.version, range, &#123; <span class="attr">includePrerelease</span>: <span class="literal">true</span> &#125;)) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(</span><br><span class="line">      <span class="string">`Require @vue/cli-service &quot;<span class="subst">$&#123;range&#125;</span>&quot;, but was loaded with &quot;<span class="subst">$&#123;<span class="built_in">this</span>.version&#125;</span>&quot;.`</span></span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Current working directory.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  getCwd () &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.service.context</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Resolve path for a project.</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param <span class="type">&#123;string&#125;</span> <span class="variable">_path</span></span> - Relative path from project root</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return <span class="type">&#123;string&#125;</span> </span>The resolved absolute path.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  resolve (_path) &#123;</span><br><span class="line">    <span class="keyword">return</span> path.resolve(<span class="built_in">this</span>.service.context, _path)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Check if the project has a given plugin.</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param <span class="type">&#123;string&#125;</span> <span class="variable">id</span></span> - Plugin id, can omit the (<span class="doctag">@vue</span>/|vue-|<span class="doctag">@scope</span>/vue)-cli-plugin- prefix</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return <span class="type">&#123;boolean&#125;</span></span></span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  hasPlugin (id) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.service.plugins.some(<span class="function"><span class="params">p</span> =&gt;</span> matchesPluginId(id, p.id))</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Register a command that will become available as `vue-cli-service [name]`.</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param <span class="type">&#123;string&#125;</span> <span class="variable">name</span></span></span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param <span class="type">&#123;object&#125;</span> </span>[opts]</span></span><br><span class="line"><span class="comment">   *   &#123;</span></span><br><span class="line"><span class="comment">   *     description: string,</span></span><br><span class="line"><span class="comment">   *     usage: string,</span></span><br><span class="line"><span class="comment">   *     options: &#123; [string]: string &#125;</span></span><br><span class="line"><span class="comment">   *   &#125;</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param <span class="type">&#123;function&#125;</span> <span class="variable">fn</span></span></span></span><br><span class="line"><span class="comment">   *   (args: &#123; [string]: string &#125;, rawArgs: string[]) =&gt; ?Promise</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  registerCommand (name, opts, fn) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> opts === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">      fn = opts</span><br><span class="line">      opts = <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">this</span>.service.commands[name] = &#123; fn, <span class="attr">opts</span>: opts || &#123;&#125; &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Register a function that will receive a chainable webpack config</span></span><br><span class="line"><span class="comment">   * the function is lazy and won&#x27;t be called until `resolveWebpackConfig` is</span></span><br><span class="line"><span class="comment">   * called</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param <span class="type">&#123;function&#125;</span> <span class="variable">fn</span></span></span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  chainWebpack (fn) &#123;</span><br><span class="line">    <span class="built_in">this</span>.service.webpackChainFns.push(fn)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Register</span></span><br><span class="line"><span class="comment">   * - a webpack configuration object that will be merged into the config</span></span><br><span class="line"><span class="comment">   * OR</span></span><br><span class="line"><span class="comment">   * - a function that will receive the raw webpack config.</span></span><br><span class="line"><span class="comment">   *   the function can either mutate the config directly or return an object</span></span><br><span class="line"><span class="comment">   *   that will be merged into the config.</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param <span class="type">&#123;object | function&#125;</span> <span class="variable">fn</span></span></span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  configureWebpack (fn) &#123;</span><br><span class="line">    <span class="built_in">this</span>.service.webpackRawConfigFns.push(fn)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Register a dev serve config function. It will receive the express `app`</span></span><br><span class="line"><span class="comment">   * instance of the dev server.</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param <span class="type">&#123;function&#125;</span> <span class="variable">fn</span></span></span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  configureDevServer (fn) &#123;</span><br><span class="line">    <span class="built_in">this</span>.service.devServerConfigFns.push(fn)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Resolve the final raw webpack config, that will be passed to webpack.</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param <span class="type">&#123;ChainableWebpackConfig&#125;</span> </span>[chainableConfig]</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return <span class="type">&#123;object&#125;</span> </span>Raw webpack config.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  resolveWebpackConfig (chainableConfig) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.service.resolveWebpackConfig(chainableConfig)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Resolve an intermediate chainable webpack config instance, which can be</span></span><br><span class="line"><span class="comment">   * further tweaked before generating the final raw webpack config.</span></span><br><span class="line"><span class="comment">   * You can call this multiple times to generate different branches of the</span></span><br><span class="line"><span class="comment">   * base webpack config.</span></span><br><span class="line"><span class="comment">   * See https://github.com/mozilla-neutrino/webpack-chain</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return <span class="type">&#123;ChainableWebpackConfig&#125;</span></span></span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  resolveChainableWebpackConfig () &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.service.resolveChainableWebpackConfig()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Generate a cache identifier from a number of variables</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  genCacheConfig (id, partialIdentifier, configFiles = []) &#123;</span><br><span class="line">    <span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>)</span><br><span class="line">    <span class="keyword">const</span> cacheDirectory = <span class="built_in">this</span>.resolve(<span class="string">`node_modules/.cache/<span class="subst">$&#123;id&#125;</span>`</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// replace \r\n to \n generate consistent hash</span></span><br><span class="line">    <span class="keyword">const</span> fmtFunc = <span class="function"><span class="params">conf</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">typeof</span> conf === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> conf.toString().replace(<span class="regexp">/\r\n?/g</span>, <span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> conf</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> variables = &#123;</span><br><span class="line">      partialIdentifier,</span><br><span class="line">      <span class="string">&#x27;cli-service&#x27;</span>: <span class="built_in">require</span>(<span class="string">&#x27;../package.json&#x27;</span>).version,</span><br><span class="line">      env: process.env.NODE_ENV,</span><br><span class="line">      test: !!process.env.VUE_CLI_TEST,</span><br><span class="line">      config: [</span><br><span class="line">        fmtFunc(<span class="built_in">this</span>.service.projectOptions.chainWebpack),</span><br><span class="line">        fmtFunc(<span class="built_in">this</span>.service.projectOptions.configureWebpack)</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      variables[<span class="string">&#x27;cache-loader&#x27;</span>] = <span class="built_in">require</span>(<span class="string">&#x27;cache-loader/package.json&#x27;</span>).version</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">      <span class="comment">// cache-loader is only intended to be used for webpack 4</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">Array</span>.isArray(configFiles)) &#123;</span><br><span class="line">      configFiles = [configFiles]</span><br><span class="line">    &#125;</span><br><span class="line">    configFiles = configFiles.concat([</span><br><span class="line">      <span class="string">&#x27;package-lock.json&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;yarn.lock&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;pnpm-lock.yaml&#x27;</span></span><br><span class="line">    ])</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> readConfig = <span class="function"><span class="params">file</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> absolutePath = <span class="built_in">this</span>.resolve(file)</span><br><span class="line">      <span class="keyword">if</span> (!fs.existsSync(absolutePath)) &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (absolutePath.endsWith(<span class="string">&#x27;.js&#x27;</span>)) &#123;</span><br><span class="line">        <span class="comment">// should evaluate config scripts to reflect environment variable changes</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="built_in">JSON</span>.stringify(<span class="built_in">require</span>(absolutePath))</span><br><span class="line">        &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">          <span class="keyword">return</span> fs.readFileSync(absolutePath, <span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> fs.readFileSync(absolutePath, <span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    variables.configFiles = configFiles.map(<span class="function"><span class="params">file</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> content = readConfig(file)</span><br><span class="line">      <span class="keyword">return</span> content &amp;&amp; content.replace(<span class="regexp">/\r\n?/g</span>, <span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> cacheIdentifier = hash(variables)</span><br><span class="line">    <span class="keyword">return</span> &#123; cacheDirectory, cacheIdentifier &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = PluginAPI</span><br></pre></td></tr></table></figure>
<p>简单介绍一些 PluginAPI 常用的方法：</p>
<ul>
<li>registerCommand: 注册 cli 命令服务</li>
<li>chainWebpack: 通过 webpack-chain 修改 webpack 配置</li>
<li>configureWebpack: 通过 webpack-merge 对 webpack 配置进行合并</li>
<li>resolveWebpackConfig: 调用之前通过 chainWebpack 和 configureWebpack 上完成的对于 webpack 配置的改造，并返回最终的 webpack 配置</li>
<li>genCacheConfig: 返回 cacheDirectory, cacheIdentifier</li>
<li>…</li>
</ul>
<p>系统的内置插件 builtInPlugins 例如 ‘./commands/serve’、’./commands/build’ 等也是通过调用 PluginAPI 提供的具体方法实现其功能，我们以 serve 命令为例：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// @vue/cli-service/lib/commands/serve.js</span></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function">(<span class="params">api, options</span>) =&gt;</span> &#123;</span><br><span class="line">  api.registerCommand(<span class="string">&#x27;serve&#x27;</span>, &#123;</span><br><span class="line">    description: <span class="string">&#x27;start development server&#x27;</span>,</span><br><span class="line">    usage: <span class="string">&#x27;vue-cli-service serve [options] [entry]&#x27;</span>,</span><br><span class="line">    options: &#123;</span><br><span class="line">      <span class="string">&#x27;--open&#x27;</span>: <span class="string">`open browser on server start`</span>,</span><br><span class="line">      <span class="string">&#x27;--copy&#x27;</span>: <span class="string">`copy url to clipboard on server start`</span>,</span><br><span class="line">      <span class="string">&#x27;--mode&#x27;</span>: <span class="string">`specify env mode (default: development)`</span>,</span><br><span class="line">      <span class="string">&#x27;--host&#x27;</span>: <span class="string">`specify host (default: <span class="subst">$&#123;defaults.host&#125;</span>)`</span>,</span><br><span class="line">      <span class="string">&#x27;--port&#x27;</span>: <span class="string">`specify port (default: <span class="subst">$&#123;defaults.port&#125;</span>)`</span>,</span><br><span class="line">      <span class="string">&#x27;--https&#x27;</span>: <span class="string">`use https (default: <span class="subst">$&#123;defaults.https&#125;</span>)`</span>,</span><br><span class="line">      <span class="string">&#x27;--public&#x27;</span>: <span class="string">`specify the public network URL for the HMR client`</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, <span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">serve</span> (<span class="params">args</span>) </span>&#123;</span><br><span class="line">   <span class="comment">// resolveWebpackConfig</span></span><br><span class="line">   <span class="comment">// create server</span></span><br><span class="line">   <span class="comment">// ....</span></span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>利用 api.registerCommand 注册了 serve 命名，并将 serve 命令的处理函数挂载到 Service 实例的 serve 命令中，当然你还可以通过 module.exports.defaultModes 以 <code>&#123; [commandName]: mode &#125;</code> 的形式来指定命令的运行模式。</p>
<p>分析到这里你应该逐渐熟悉 vue-cli 3.0 的插件机制了，vue-cli 3.0 将所有的工作都交给插件去执行，开发模式执行内置 serve 插件，打包执行内置 build 插件，检查代码规范由 @vue/cli-plugin-eslint 插件完成。</p>
<p>在加载完所有的插件以后，实例的 init 方法在最后会读取项目配置中的 webpack 配置信息，即 chainWebpack 和 configureWebpack，代码如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// apply webpack configs from project config file</span></span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">this</span>.projectOptions.chainWebpack) &#123;</span><br><span class="line">  <span class="built_in">this</span>.webpackChainFns.push(<span class="built_in">this</span>.projectOptions.chainWebpack)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">this</span>.projectOptions.configureWebpack) &#123;</span><br><span class="line">  <span class="built_in">this</span>.webpackRawConfigFns.push(<span class="built_in">this</span>.projectOptions.configureWebpack)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在实例的 run 函数中执行了实例 init 函数对 Service 实例的属性进行初始化后就会解析 CLI 命令，具体实现如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">args._ = args._ || []</span><br><span class="line"><span class="keyword">let</span> command = <span class="built_in">this</span>.commands[name] <span class="comment">// 加载插件时注册了 command，api.registerCommand</span></span><br><span class="line"><span class="keyword">if</span> (!command &amp;&amp; name) &#123; <span class="comment">// 非法命令</span></span><br><span class="line">  error(<span class="string">`command &quot;<span class="subst">$&#123;name&#125;</span>&quot; does not exist.`</span>)</span><br><span class="line">  process.exit(<span class="number">1</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (!command || args.help) &#123; <span class="comment">// vue-cli-service || vue-cli-service -h</span></span><br><span class="line">  command = <span class="built_in">this</span>.commands.help</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  args._.shift() <span class="comment">// remove command itself</span></span><br><span class="line">  rawArgv.shift()</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> &#123; fn &#125; = command</span><br><span class="line"><span class="keyword">return</span> fn(args, rawArgv)</span><br></pre></td></tr></table></figure>
<p>会先对 CLI 命令进行一个判断，主要有一下三种情况：</p>
<ul>
<li>输入了命令 name ，但是并没有通过 api.registerCommand 注册，即非法命令，process.exit(1)</li>
<li>直接输入了 vue-cli-service 或者 vue-cli-service --help，加载内置 help 插件</li>
<li>正常输入，eg: vue-cli-service test:unit，这种情况会加载对应地单元测试插件 @vue/cli-plugin-unit-jest || @vue/cli-plugin-unit-mocha，并执行插件内与对应 test 命令指定的处理函数。</li>
</ul>
<h4 id="4-总结"><a class="markdownIt-Anchor" href="#4-总结"></a> 4、总结</h4>
<p>至此 @vue/cli-service 的分析就完成了，@vue/cli-service 的主要作用就是提供了 vue-cli-service 命令，但是与一般 node 命令文件有点不同，@vue/cli-service 并没有直接提供相关 serve、build 等 CLI 命令的服务。具体实现主要是通过 Service 实例的 run 方法，run 方法主要执行了环境变量文件加载，获取项目配置信息，合并项目配置，加载插件，加载项目配置中的 webpack 信息，最后 执行 CLI 服务，常见的 serve 和 build 指令也是通过系统提供的内置插件实现的，在下面我们将详细介绍 Vue CLI 的最后一个核心内容：插件。</p>
<h3 id="四-插件"><a class="markdownIt-Anchor" href="#四-插件"></a> 四、插件</h3>
<p>（已经六万字了，，，我当时论文都没这么多字😭）</p>
<p>通过前文对于 @vue/cli 和 @vue/cli-service 的介绍我们也已经初步知道了 Vue CLI 中插件的重要性，一个 CLI 插件是一个 npm 包，它能够为 Vue CLI 创建的项目添加额外的功能，这些功能包括：</p>
<ul>
<li>修改项目的 webpack 配置 - 例如，如果你的插件希望去针对某种类型的文件工作，你可以为这个特定的文件扩展名添加新的 webpack 解析规则。比如说，@vue/cli-plugin-typescript 就添加这样的规则来解析 .ts 和 .tsx 扩展的文件；</li>
<li>添加新的 vue-cli-service 命令 - 例如，@vue/cli-plugin-unit-jest 添加了 test:unit 命令，允许开发者运行单元测试；</li>
<li>扩展 package.json - 当你的插件添加了一些依赖到项目中，你需要将他们添加到 package 的 dependencies 部分时，这是一个有用的选项；</li>
<li>在项目中创建新文件、或者修改老文件。有时创建一个示例组件或者通过给入口文件（main.js）添加导入（imports）是一个好的主意；</li>
<li>提示用户选择一个特定的选项 - 例如，你可以询问用户是否创建我们前面提到的示例组件。</li>
</ul>
<p>CLI 插件应该总是包含一个 service 插件 做为主的导出，并且他能够选择性的包含 generator, prompt 文件 和 Vue UI 集成。</p>
<p>作为一个 npm 包，CLI 插件必须有一个 package.json 文件。通常建议在 <a target="_blank" rel="noopener" href="http://README.md">README.md</a> 中包含插件的描述，来帮助其他人在 npm 上发现你的插件。</p>
<p>所以，通常的 CLI 插件目录结构看起来像下面这样：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── README.md</span><br><span class="line">├── generator.js  <span class="comment"># generator（可选）</span></span><br><span class="line">├── index.js      <span class="comment"># service 插件</span></span><br><span class="line">├── package.json</span><br><span class="line">├── prompts.js    <span class="comment"># prompt 文件（可选）</span></span><br><span class="line">└── ui.js         <span class="comment"># Vue UI 集成（可选）</span></span><br></pre></td></tr></table></figure>
<h4 id="1-packagejson"><a class="markdownIt-Anchor" href="#1-packagejson"></a> 1、package.json</h4>
<p>为了让一个 CLI 插件在 Vue CLI 项目中被正常使用，它必须遵循 vue-cli-plugin-<name> 或者 @scope/vue-cli-plugin-<name> 这样的命名惯例。这样你的插件才能够：</p>
<ul>
<li>被 @vue/cli-service 发现;</li>
<li>被其他开发者通过搜索发现;</li>
<li>通过 <code>vue add &lt;name&gt;</code> 或者 <code>vue invoke &lt;name&gt;</code> 安装;</li>
</ul>
<p>为了能够被用户在搜索时更好的发现，keywords 尽可能多写一些项目相关的词，同时可以将插件的关键描述放到 description 字段中。</p>
<p>例如：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;vue-cli-plugin-apollo&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;version&quot;</span>: <span class="string">&quot;0.7.7&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;description&quot;</span>: <span class="string">&quot;vue-cli plugin to add Apollo and GraphQL&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>你应该在 homepage 或者 repository 字段添加创建插件的官网地址或者仓库的地址，这样你的插件详情里就会出现一个 查看详情 按钮：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;repository&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;git&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;url&quot;</span>: <span class="string">&quot;git+https://github.com/Akryum/vue-cli-plugin-apollo.git&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;homepage&quot;</span>: <span class="string">&quot;https://github.com/Akryum/vue-cli-plugin-apollo#readme&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2-generator"><a class="markdownIt-Anchor" href="#2-generator"></a> 2、generator</h4>
<p>插件的 Generator 部分通常在你想要为项目扩展包依赖，创建新的文件或者编辑已经存在的文件时需要。在 CLI 插件内部，generator 应该放在 generator.js 或者 generator/index.js 文件中。它将在以下两个场景被调用：</p>
<ul>
<li>项目初始创建期间，CLI 插件被作为项目创建 preset 的一部分被安装时。</li>
<li>当插件在项目创建完成和通过 vue add 或者 vue invoke 单独调用被安装时。</li>
</ul>
<p>一个 generator 应该导出一个接收三个参数的函数：</p>
<p>1、一个 GeneratorAPI 实例；</p>
<p>2、插件的 generator 选项。这些选项在项目创建，或者从 ~/.vuerc 载入预设时被解析。例如：如果保存的 ~/.vuerc 像这样：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;presets&quot;</span> : &#123;</span><br><span class="line">    <span class="attr">&quot;foo&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;plugins&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;@vue/cli-plugin-foo&quot;</span>: &#123; <span class="attr">&quot;option&quot;</span>: <span class="string">&quot;bar&quot;</span> &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果用户使用 preset foo 创建了一个项目，那么 @vue/cli-plugin-foo 的 generator 就会收到 { option: ‘bar’ } 作为第二个参数。</p>
<p>对于第三方插件，这个选项将在用户执行 vue invoke 时，从提示或者命令行参数中被解析。</p>
<p>3、整个 preset (presets.foo) 将会作为第三个参数传入。</p>
<p>关于 GeneratorAPI 我们已经在前面解析 @vue/cli 的过程中进行了详细介绍，那么我们通过 GeneratorAPI 可以实现哪些功能呢？</p>
<p><strong>1、创建新的模板</strong></p>
<p>当你调用 api.render(’./template’) 时，该 generator 将会使用 EJS 渲染 ./template 中的文件 (相对于 generator 中的文件路径进行解析)</p>
<p>想象我们正在创建 vue-cli-auto-routing 插件，我们希望当插件在项目中被引用时做以下的改变：</p>
<ul>
<li>创建一个 layouts 文件夹包含默认布局文件；</li>
<li>创建一个 pages 文件夹包含 about 和 home 页面；</li>
<li>在 src 文件夹中添加 router.js 文件</li>
</ul>
<p>为了渲染这个结构，你需要在 generator/template 文件夹内创建它：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── src</span><br><span class="line"> ├── layouts</span><br><span class="line">  ├── default.vue</span><br><span class="line"> ├── pages</span><br><span class="line">  ├── about.vue</span><br><span class="line">  ├── home.vue</span><br><span class="line"> ├── router</span><br><span class="line">  └── index.js</span><br></pre></td></tr></table></figure>
<p>模板创建完之后，我们就可以在 generator/index.js 文件中添加 api.render(’./template’) 来调用。</p>
<p>不过需要注意文件名的边界情况，如果你想要渲染一个以点开头的模板文件 (例如 .env)，则需要遵循一个特殊的命名约定，因为以点开头的文件会在插件发布到 npm 的时候被忽略：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 以点开头的模板需要使用下划线取代那个点：</span></span><br><span class="line"></span><br><span class="line">/generator/template/_env</span><br><span class="line"></span><br><span class="line"><span class="comment"># 当调用 api.render(&#x27;./template&#x27;) 时，它在项目文件夹中将被渲染为：</span></span><br><span class="line"></span><br><span class="line">/generator/template/.env</span><br></pre></td></tr></table></figure>
<p>同时这也意味着当你想渲染以下划线开头的文件时，同样需要遵循一个特殊的命名约定：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 这种模板需要使用两个下划线来取代单个下划线：</span></span><br><span class="line"></span><br><span class="line">/generator/template/__variables.scss</span><br><span class="line"></span><br><span class="line"><span class="comment"># 当调用 api.render(&#x27;./template&#x27;) 时，它在项目文件夹中将被渲染为：</span></span><br><span class="line"></span><br><span class="line">/generator/template/_variable.scss</span><br></pre></td></tr></table></figure>
<p><strong>2、编辑已经存在的模板</strong></p>
<p>此外，你可以使用 YAML 前置元信息继承并替换已有的模板文件的一部分（即使来自另一个包）：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">extend:</span> <span class="string">&#x27;@vue/cli-service/generator/template/src/App.vue&#x27;</span></span><br><span class="line"><span class="attr">replace:</span> <span class="type">!!js/regexp</span> <span class="string">/&lt;script&gt;[^]*?&lt;\/script&gt;/</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"></span><br><span class="line"><span class="string">&lt;script&gt;</span></span><br><span class="line"><span class="string">export</span> <span class="string">default</span> &#123;</span><br><span class="line">  <span class="string">//</span> <span class="string">替换默认脚本</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="string">&lt;/script&gt;</span></span><br></pre></td></tr></table></figure>
<p>也可以替换多处，只不过你需要将替换的字符串包裹在 &lt;%# REPLACE %&gt; 和 &lt;%# END_REPLACE %&gt; 块中：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">extend:</span> <span class="string">&#x27;@vue/cli-service/generator/template/src/App.vue&#x27;</span></span><br><span class="line"><span class="attr">replace:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="type">!!js/regexp</span> <span class="string">/Welcome</span> <span class="string">to</span> <span class="string">Your</span> <span class="string">Vue\.js</span> <span class="string">App/</span></span><br><span class="line">  <span class="bullet">-</span> <span class="type">!!js/regexp</span> <span class="string">/&lt;script&gt;[^]*?&lt;\/script&gt;</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"></span><br><span class="line">&lt;%<span class="ruby"><span class="comment"># REPLACE </span></span>%&gt;</span><br><span class="line"><span class="string">替换欢迎信息</span></span><br><span class="line">&lt;%<span class="ruby"><span class="comment"># END_REPLACE </span></span>%&gt;</span><br><span class="line"></span><br><span class="line">&lt;%<span class="ruby"><span class="comment"># REPLACE </span></span>%&gt;</span><br><span class="line"><span class="string">&lt;script&gt;</span></span><br><span class="line"><span class="string">export</span> <span class="string">default</span> &#123;</span><br><span class="line">  <span class="string">//</span> <span class="string">替换默认脚本</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="string">&lt;/script&gt;</span></span><br><span class="line">&lt;%<span class="ruby"><span class="comment"># END_REPLACE </span></span>%&gt;</span><br></pre></td></tr></table></figure>
<p><strong>3、扩展包</strong></p>
<p>如果你需要向项目中添加额外的依赖，创建一个 npm 脚本或者修改 package.json 的其他任何一处，你可以使用 API extendPackage 方法。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// generator/index.js</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="params">api</span> =&gt;</span> &#123;</span><br><span class="line">  api.extendPackage(&#123;</span><br><span class="line">    dependencies: &#123;</span><br><span class="line">      <span class="string">&#x27;vue-router-layout&#x27;</span>: <span class="string">&#x27;^0.1.2&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在上面这个例子中，我们添加了一个依赖：vue-router-layout。在插件调用时，这个 npm 模块将被安装，这个依赖将被添加到用户项目的 package.json 文件。</p>
<p>同样使用这个 API 我们可以添加新的 npm 任务到项目中。为了实现这个，我们需要定义一个任务名和一个命令，这样他才能够在用户 package.json 文件的 scripts 部分运行：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// generator/index.js</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="params">api</span> =&gt;</span> &#123;</span><br><span class="line">  api.extendPackage(&#123;</span><br><span class="line">    scripts: &#123;</span><br><span class="line">      greet: <span class="string">&#x27;vue-cli-service greet&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在上面这个例子中，我们添加了一个新的 greet 任务来执行一个创建在 Service 部分 的自定义 vue-cli 服务命令。</p>
<p><strong>4、修改主文件</strong></p>
<p>通过 generator 方法你能够修改项目中的文件。最有用的场景是针对 main.js 或 main.ts 文件的一些修改：新的导入，新的 Vue.use() 调用等。</p>
<p>让我们来思考一个场景，当我们通过 模板 创建了一个 router.js 文件，现在我们希望导入这个路由到主文件中。我们将用到两个 generator API 方法： entryFile 将返回项目的主文件（main.js 或 main.ts），injectImports 用于添加新的导入到主文件中：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// generator/index.js</span></span><br><span class="line"></span><br><span class="line">api.injectImports(api.entryFile, <span class="string">`import router from &#x27;./router&#x27;`</span>)</span><br></pre></td></tr></table></figure>
<p>现在，当我们路由被导入时，我们可以在主文件中将这个路由注入到 Vue 实例。我们可以使用 afterInvoke 钩子，这个钩子将在文件被写入硬盘之后被调用。</p>
<p>首先，我们需要通过 Node 的 fs 模块（提供了文件交互 API）读取文件内容，将内容拆分</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// generator/index.js</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports.hooks = <span class="function">(<span class="params">api</span>) =&gt;</span> &#123;</span><br><span class="line">  api.afterInvoke(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>)</span><br><span class="line">    <span class="keyword">const</span> contentMain = fs.readFileSync(api.resolve(api.entryFile), &#123; <span class="attr">encoding</span>: <span class="string">&#x27;utf-8&#x27;</span> &#125;)</span><br><span class="line">    <span class="keyword">const</span> lines = contentMain.split(<span class="regexp">/\r?\n/g</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后我们需要找到包含 render 单词的字符串（它通常是 Vue 实例的一部分），router 就是下一个字符串：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// generator/index.js</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports.hooks = <span class="function">(<span class="params">api</span>) =&gt;</span> &#123;</span><br><span class="line">  api.afterInvoke(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>)</span><br><span class="line">    <span class="keyword">const</span> contentMain = fs.readFileSync(api.resolve(api.entryFile), &#123; <span class="attr">encoding</span>: <span class="string">&#x27;utf-8&#x27;</span> &#125;)</span><br><span class="line">    <span class="keyword">const</span> lines = contentMain.split(<span class="regexp">/\r?\n/g</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> renderIndex = lines.findIndex(<span class="function"><span class="params">line</span> =&gt;</span> line.match(<span class="regexp">/render/</span>))</span><br><span class="line">    lines[renderIndex] += <span class="string">`\n router,`</span></span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最后，你需要将内容写入主文件：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// generator/index.js</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports.hooks = <span class="function">(<span class="params">api</span>) =&gt;</span> &#123;</span><br><span class="line">  api.afterInvoke(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; EOL &#125; = <span class="built_in">require</span>(<span class="string">&#x27;os&#x27;</span>)</span><br><span class="line">    <span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>)</span><br><span class="line">    <span class="keyword">const</span> contentMain = fs.readFileSync(api.resolve(api.entryFile), &#123; <span class="attr">encoding</span>: <span class="string">&#x27;utf-8&#x27;</span> &#125;)</span><br><span class="line">    <span class="keyword">const</span> lines = contentMain.split(<span class="regexp">/\r?\n/g</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> renderIndex = lines.findIndex(<span class="function"><span class="params">line</span> =&gt;</span> line.match(<span class="regexp">/render/</span>))</span><br><span class="line">    lines[renderIndex] += <span class="string">`<span class="subst">$&#123;EOL&#125;</span>  router,`</span></span><br><span class="line"></span><br><span class="line">    fs.writeFileSync(api.entryFile, lines.join(EOL), &#123; <span class="attr">encoding</span>: <span class="string">&#x27;utf-8&#x27;</span> &#125;)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="3-service-插件"><a class="markdownIt-Anchor" href="#3-service-插件"></a> 3、service 插件</h4>
<p>Service 插件可以修改 webpack 配置，创建新的 vue-cli service 命令或者修改已经存在的命令（如 serve 和 build）。</p>
<p>Service 插件在 Service 实例被创建后自动加载 - 例如，每次 vue-cli-service 命令在项目中被调用的时候。它位于 CLI 插件根目录的 index.js 文件。</p>
<p>一个 service 插件应该导出一个函数，这个函数接受两个参数：</p>
<ul>
<li>一个 PluginAPI 实例</li>
<li>一个包含 vue.config.js 内指定的项目本地选项的对象，或者在 package.json 内的 vue 字段。</li>
</ul>
<p>PluginAPI 为 service 插件提供了针对不同的环境扩展/修改内部的 webpack 配置的能力。例如，这里我们在 webpack-chain 中添加 vue-auto-routing 这个 webpack 插件，并指定参数：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> VueAutoRoutingPlugin = <span class="built_in">require</span>(<span class="string">&#x27;vue-auto-routing/lib/webpack-plugin&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function">(<span class="params">api, options</span>) =&gt;</span> &#123;</span><br><span class="line">  api.chainWebpack(<span class="function"><span class="params">webpackConfig</span> =&gt;</span> &#123;</span><br><span class="line">    webpackConfig</span><br><span class="line">    .plugin(<span class="string">&#x27;vue-auto-routing&#x27;</span>)</span><br><span class="line">      .use(VueAutoRoutingPlugin, [</span><br><span class="line">        &#123;</span><br><span class="line">          pages: <span class="string">&#x27;src/pages&#x27;</span>,</span><br><span class="line">          nested: <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">      ])</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>你也可以使用 configureWebpack 方法修改 webpack 配置或者返回一个对象，返回的对象将通过 webpack-merge 被合并到配置中。</p>
<p>除了修改 webpack 配置之外我们还可以通过 Service 插件实现如下功能：</p>
<p><strong>1、添加一个新的 cli-service 命令</strong></p>
<p>通过 service 插件你可以注册一个新的 cli-service 命令，除了标准的命令（即 serve 和 build）。你可以使用 registerCommand API 方法实现。</p>
<p>下面的例子创建了一个简单的新命令，可以向开发控制台输出一条问候语：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">api.registerCommand(</span><br><span class="line">  <span class="string">&#x27;greet&#x27;</span>,</span><br><span class="line">  &#123;</span><br><span class="line">    description: <span class="string">&#x27;Write a greeting to the console&#x27;</span>,</span><br><span class="line">    usage: <span class="string">&#x27;vue-cli-service greet&#x27;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  () =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`👋  Hello`</span>)</span><br><span class="line">  &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>在这个例子中，我们提供了命令的名字（‘greet’）、一个有 description 和 usage 选项的对象，和一个在执行 vue-cli-service greet 命令时会调用的函数。</p>
<p>如果你在已经安装了插件的项目中运行新命令，你将看到下面的输出：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ vue-cli-service greet</span><br><span class="line">👋 Hello!</span><br></pre></td></tr></table></figure>
<p>你也可以给新命令定义一系列可能的选项。接下来我们添加一个 --name 选项，并修改实现函数，当提供了 name 参数时把它也打印出来。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">api.registerCommand(</span><br><span class="line">  <span class="string">&#x27;greet&#x27;</span>,</span><br><span class="line">  &#123;</span><br><span class="line">    description: <span class="string">&#x27;Writes a greeting to the console&#x27;</span>,</span><br><span class="line">    usage: <span class="string">&#x27;vue-cli-service greet [options]&#x27;</span>,</span><br><span class="line">    options: &#123; <span class="string">&#x27;--name&#x27;</span>: <span class="string">&#x27;specifies a name for greeting&#x27;</span> &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  args =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (args.name) &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">`👋 Hello, <span class="subst">$&#123;args.name&#125;</span>!`</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">`👋 Hello!`</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>现在，如果 greet 命令携带了特定的 --name 选项，这个 name 被添加到控制台输出：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ vue-cli-service greet --name <span class="string">&#x27;John Doe&#x27;</span></span><br><span class="line">👋 Hello, John Doe!</span><br></pre></td></tr></table></figure>
<p><strong>2、修改已经存在的 cli-service 命令</strong></p>
<p>如果你想修改一个已经存在的 cli-service 命令，你可以使用 api.service.commands 获取到命令对象并且做些改变。我们将在应用程序运行的端口打印一条信息到控制台：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; serve &#125; = api.service.commands</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> serveFn = serve.fn</span><br><span class="line"></span><br><span class="line">serve.fn = <span class="function">(<span class="params">...args</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> serveFn(...args).then(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="function"><span class="title">if</span>(<span class="params">res &amp;&amp; res.url</span>)</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">`Project is running now at <span class="subst">$&#123;res.url&#125;</span>`</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在上面的这个例子中，我们从已经存在的命令列表中获取到命令对象 serve；然后我们修改了他的 fn 部分（fn 是创建这个新命令时传入的第三个参数；它定义了在执行这个命令时要执行的函数）。修改完后，这个控制台消息将在 serve 命令成功运行后打印。</p>
<p><strong>3、为命令指定模式</strong></p>
<p>如果一个已注册的插件命令需要运行在特定的默认模式下，则该插件需要通过 module.exports.defaultModes 以 { [commandName]: mode } 的形式来暴露：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="params">api</span> =&gt;</span> &#123;</span><br><span class="line">  api.registerCommand(<span class="string">&#x27;build&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports.defaultModes = &#123;</span><br><span class="line">  build: <span class="string">&#x27;production&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这是因为我们需要在加载环境变量之前知道该命令的预期模式，所以需要提前加载用户选项/应用插件。</p>
<h4 id="4-prompt-文件"><a class="markdownIt-Anchor" href="#4-prompt-文件"></a> 4、prompt 文件</h4>
<p>对话是在创建一个新的项目或者在已有项目中添加新的插件时处理用户选项时需要的。所有的对话逻辑都存储在 prompts.js 文件中。对话内部是通过 inquirer 实现。</p>
<p>当用户通过调用 vue invoke 初始化插件时，如果插件根目录包含 prompts.js，它将在调用时被使用。这个文件应该导出一个问题数组 – 将被 Inquirer.js 处理。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// prompts.js </span></span><br><span class="line"><span class="comment">// 直接返回问题数组</span></span><br><span class="line"><span class="built_in">module</span>.exports = [</span><br><span class="line">  &#123;</span><br><span class="line">    type: <span class="string">&#x27;input&#x27;</span>,</span><br><span class="line">    name: <span class="string">&#x27;locale&#x27;</span>,</span><br><span class="line">    message: <span class="string">&#x27;The locale of project localization.&#x27;</span>,</span><br><span class="line">    validate: <span class="function"><span class="params">input</span> =&gt;</span> !!input,</span><br><span class="line">    <span class="keyword">default</span>: <span class="string">&#x27;en&#x27;</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="comment">// 返回问题数组的函数</span></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="params">pkg</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> prompts = [</span><br><span class="line">    &#123;</span><br><span class="line">      type: <span class="string">&#x27;input&#x27;</span>,</span><br><span class="line">      name: <span class="string">&#x27;locale&#x27;</span>,</span><br><span class="line">      message: <span class="string">&#x27;The locale of project localization.&#x27;</span>,</span><br><span class="line">      validate: <span class="function"><span class="params">input</span> =&gt;</span> !!input,</span><br><span class="line">      <span class="keyword">default</span>: <span class="string">&#x27;en&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 添加动态对话</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="string">&#x27;@vue/cli-plugin-eslint&#x27;</span> <span class="keyword">in</span> (pkg.devDependencies || &#123;&#125;)) &#123;</span><br><span class="line">    prompts.push(&#123;</span><br><span class="line">      type: <span class="string">&#x27;confirm&#x27;</span>,</span><br><span class="line">      name: <span class="string">&#x27;useESLintPluginVueI18n&#x27;</span>,</span><br><span class="line">      message: <span class="string">&#x27;Use ESLint plugin for Vue I18n ?&#x27;</span></span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> prompts</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>解析到的答案对象将作为选项传入到插件的 generator。如果我们想在 generator 中使用用户的选择结果，可以通过对话名字获得。例如我们可以修改一下 generator/index.js：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (options.useESLintPluginVueI18n) &#123;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="5-vue-ui-集成"><a class="markdownIt-Anchor" href="#5-vue-ui-集成"></a> 5、Vue UI 集成</h4>
<p>Vue CLI 有一个非常强大的 UI 工具 – 允许用户通过图形接口来架构和管理项目。Vue CLI 插件能够集成到接口中。UI 为 CLI 插件提供了额外的功能：</p>
<ul>
<li>可以执行 npm 任务，直接在 UI 中执行插件中定义的命令；</li>
<li>可以展示插件的自定义配置。</li>
<li>当创建项目时，你可以展示对话</li>
<li>如果你想支持多种语言，你可以为你的插件添加本地化</li>
<li>你可以使插件在 Vue UI 搜索中被搜索到</li>
</ul>
<p>图形化配置及管理也是 Vue CLI 最新架构的一个重要亮点，个人感觉实际插件开发比较少用，所以此处不再展开，详细配置方法请查看<a target="_blank" rel="noopener" href="https://cli.vuejs.org/zh/dev-guide/plugin-dev.html#ui-%E9%9B%86%E6%88%90">官方文档</a></p>
<p>至此对于 Vue CLI 的架构的主要分析全部完成，这种基于插件机制的架构为开发者提供了终端命令行工具、零配置脚手架、插件体系、图形化管理界面等诸多功能，相较于早前的  vue-cli 其可配置性强，极为灵活并且版本依赖易于管理与升级，就很牛皮！</p>
<img src="/assets/emoji/05.jpg" width="280" />
<h2 id="参考资料"><a class="markdownIt-Anchor" href="#参考资料"></a> 参考资料</h2>
<p><a target="_blank" rel="noopener" href="https://kuangpf.com/vue-cli-analysis">vue-cli-analysis</a></p>
<p><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1781202">剖析 Vue CLI 实现原理</a></p>
<p><a target="_blank" rel="noopener" href="https://cli.vuejs.org/">Vue CLI官方文档</a></p>

    </div>

    
    
    
        <div class="reward-container">
  <div></div>
  <button onclick="var qr = document.getElementById('qr'); qr.style.display = (qr.style.display === 'none') ? 'block' : 'none';">
    打赏
  </button>
  <div id="qr" style="display: none;">
      
      <div style="display: inline-block;">
        <img src="/assets/config/weixin.png" alt="kyleezhang 微信支付">
        <p>微信支付</p>
      </div>
      
      <div style="display: inline-block;">
        <img src="/assets/config/alipay.png" alt="kyleezhang 支付宝">
        <p>支付宝</p>
      </div>

  </div>
</div>

        

<div>
<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者： </strong>kyleezhang
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="http://kyleezhang.com/2021/05/15/vue-cli-02/" title="从vue-cli到Vue CLI（二）">http://kyleezhang.com/2021/05/15/vue-cli-02/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>

        

  <div class="followme">
    <p>欢迎关注我的其它发布渠道</p>

    <div class="social-list">

        <div class="social-item">
          <a target="_blank" class="social-link" href="/assets/config/wechat.png">
            <span class="icon">
              <i class="fab fa-weixin"></i>
            </span>

            <span class="label">WeChat</span>
          </a>
        </div>

        <div class="social-item">
          <a target="_blank" class="social-link" href="/atom.xml">
            <span class="icon">
              <i class="fa fa-rss"></i>
            </span>

            <span class="label">RSS</span>
          </a>
        </div>
    </div>
  </div>


      <footer class="post-footer">
          
          <div class="post-tags">
              <a href="/tags/cli/" rel="tag"><i class="fa fa-tag"></i>cli</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2021/04/21/javascript-number/" rel="prev" title="JavaScript 中的 Number 类型">
      <i class="fa fa-chevron-left"></i> JavaScript 中的 Number 类型
    </a></div>
      <div class="post-nav-item">
    <a href="/2021/06/02/javascript-array/" rel="next" title="JavaScript 中的数组">
      JavaScript 中的数组 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    <div class="comments" id="gitalk-container"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#vue-cli"><span class="nav-text"> Vue CLI</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%80-%E6%95%B4%E4%BD%93%E6%9E%B6%E6%9E%84"><span class="nav-text"> 一、整体架构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BA%8C-vuecli"><span class="nav-text"> 二、@vue&#x2F;cli</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-create-%E5%91%BD%E4%BB%A4"><span class="nav-text"> 1、create 命令</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-add-%E5%91%BD%E4%BB%A4"><span class="nav-text"> 2、add 命令</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%89-vuecli-service"><span class="nav-text"> 三、@vue&#x2F;cli-service</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-%E5%85%A5%E5%8F%A3"><span class="nav-text"> 1、入口</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-service-%E7%B1%BB%E5%AE%9E%E4%BE%8B%E5%8C%96"><span class="nav-text"> 2、Service 类实例化</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-%E5%AE%9E%E4%BE%8B%E7%9A%84-run-%E6%96%B9%E6%B3%95"><span class="nav-text"> 3、实例的 run 方法</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-%E6%80%BB%E7%BB%93"><span class="nav-text"> 4、总结</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9B%9B-%E6%8F%92%E4%BB%B6"><span class="nav-text"> 四、插件</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-packagejson"><span class="nav-text"> 1、package.json</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-generator"><span class="nav-text"> 2、generator</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-service-%E6%8F%92%E4%BB%B6"><span class="nav-text"> 3、service 插件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-prompt-%E6%96%87%E4%BB%B6"><span class="nav-text"> 4、prompt 文件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-vue-ui-%E9%9B%86%E6%88%90"><span class="nav-text"> 5、Vue UI 集成</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="nav-text"> 参考资料</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="kyleezhang"
      src="/assets/config/avatar.png">
  <p class="site-author-name" itemprop="name">kyleezhang</p>
  <div class="site-description" itemprop="description">学源于思</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">39</span>
          <span class="site-state-item-name">文章</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">7</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">12</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/kyleezhang" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;kyleezhang" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="/2942181559@qq.com" title="E-Mail → 2942181559@qq.com"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://weibo.com/u/6998903195" title="Weibo → https:&#x2F;&#x2F;weibo.com&#x2F;u&#x2F;6998903195" rel="noopener" target="_blank"><i class="fab fa-weibo fa-fw"></i>Weibo</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">kyleezhang</span>
</div>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="站点总字数">564k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">8:33</span>
</div>



        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

  

<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.css">

<script>
NexT.utils.loadComments(document.querySelector('#gitalk-container'), () => {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js', () => {
    var gitalk = new Gitalk({
      clientID    : '5cb74a324ff7b0f7b544',
      clientSecret: 'cd372db5bb46f07eda7fae4b615fd27371c80dc7',
      repo        : 'kyleezhang.github.io',
      owner       : 'kyleezhang',
      admin       : ['kyleezhang'],
      id          : '54d70eba3fe0249ff8e00cc6ecdf92dc',
        language: 'zh-CN',
      distractionFreeMode: true
    });
    gitalk.render('gitalk-container');
  }, window.Gitalk);
});
</script>

  <!-- 背景动画 -->
<script src="/js/particle.js"></script>

</body>
</html>
